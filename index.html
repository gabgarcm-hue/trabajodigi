<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quién es quién en prevención, un juego simple para conocer las figuras preventivas</title>
  <style>
    :root{
      --bg0:#05070f;
      --bg1:#0b1220;
      --panel:#0f1a33;
      --panel2:#121f3d;
      --card:#152852;
      --txt:#f5f7ff;
      --muted:#b8c4e4;
      --line:rgba(255,255,255,.14);
      --shadow: 0 22px 55px rgba(0,0,0,.55);

      --red:#ff4d4d;
      --amber:#ffb020;
      --green:#2eea7b;

      --ans:#f7f8ff;           /* fondo de respuesta antes de revelar */
      --ansTxt:#121528;        /* texto oscuro para contraste */
      --ansLine:rgba(15,20,40,.20);
      --ansShadow: 0 14px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      margin:0;
      color:var(--txt);
      background:
        radial-gradient(900px 520px at 18% 0%, rgba(75,109,255,.26) 0%, rgba(5,7,15,0) 65%),
        radial-gradient(900px 520px at 82% 10%, rgba(46,234,123,.18) 0%, rgba(5,7,15,0) 70%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:10;
      background:rgba(5,7,15,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 16px;
    }
    header .top{max-width:1040px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:15px;letter-spacing:.2px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    main{max-width:1040px;margin:0 auto;padding:16px;display:grid;gap:14px}

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .hidden{display:none !important}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: rgba(46,234,123,.45);
      background: linear-gradient(180deg, rgba(46,234,123,.24), rgba(46,234,123,.10));
    }
    .btn.ghost{background:transparent;box-shadow:none}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px;color:var(--muted);box-shadow:none}
    .btn.small b{color:var(--txt);font-weight:650}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Quiz */
    .meta{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .progress{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--line);
      width: min(560px, 100%);
    }
    .bar{height:100%;width:0%;
      background: linear-gradient(90deg, rgba(46,234,123,.25), rgba(46,234,123,.65));
    }
    .qtitle{margin:12px 0 0;font-size:22px;line-height:1.25}
    .qsub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}

    /* Respuestas (alta legibilidad) */
    .answers{margin-top:14px;display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;}
    .ans{
      min-height:78px;
      border-radius:16px;
      border:2px solid var(--ansLine);
      background:var(--ans);
      color:var(--ansTxt);
      padding:14px 14px;
      cursor:pointer;
      display:flex;align-items:flex-start;gap:12px;
      box-shadow: var(--ansShadow);
      transition: transform .06s ease, filter .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .ans:hover{filter:brightness(1.02)}
    .ans:active{transform:scale(.992)}
    .ans .tag{
      flex:0 0 auto;
      width:34px;height:34px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:800;
      background:rgba(10,12,20,.08);
      border:2px solid rgba(10,12,20,.10);
      color:rgba(10,12,20,.70);
    }
    .ans .text{font-size:15px;line-height:1.25;font-weight:650}
    .ans.locked{cursor:default}
    .ans.selected{outline:3px solid rgba(255,255,255,.35)}

    /* Revelado por color (mantiene contraste) */
    .ans.red{
      background: linear-gradient(180deg, rgba(255,77,77,.20), rgba(255,77,77,.12));
      border-color: rgba(255,77,77,.65);
      color:var(--txt);
    }
    .ans.amber{
      background: linear-gradient(180deg, rgba(255,176,32,.22), rgba(255,176,32,.12));
      border-color: rgba(255,176,32,.70);
      color:var(--txt);
    }
    .ans.green{
      background: linear-gradient(180deg, rgba(46,234,123,.20), rgba(46,234,123,.12));
      border-color: rgba(46,234,123,.70);
      color:var(--txt);
    }
    .ans.red .tag, .ans.amber .tag, .ans.green .tag{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.18);
      color:rgba(255,255,255,.88);
    }

    .feedback{
      margin-top:14px;border-radius:16px;border:1px solid var(--line);
      padding:12px;background:rgba(0,0,0,.14);
    }
    .feedback b{display:block;margin-bottom:6px}
    .feedback p{margin:0;color:var(--muted);line-height:1.4;white-space:pre-line}

    /* Resultado */
    .scoreBig{font-size:38px;margin:0}
    .split{display:grid;grid-template-columns: 1.3fr .7fr; gap:12px}
    @media (max-width:900px){ .split{grid-template-columns:1fr} .answers{grid-template-columns:1fr} }
    .list{display:grid;gap:8px;margin-top:10px}
    .item{border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
    .item small{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .badge.red{border-color:rgba(255,77,77,.45)}
    .badge.amber{border-color:rgba(255,176,32,.45)}
    .badge.green{border-color:rgba(46,234,123,.45)}

    /* Diagrama */
    .diagram{display:grid;gap:10px}
    .flow{display:flex;flex-wrap:wrap;align-items:stretch;gap:10px}
    .box{
      min-width: 190px;
      flex: 1 1 190px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.04);
      padding:12px;
    }
    .box h4{margin:0 0 6px;font-size:14px}
    .box p{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
    .arrow{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:20px;padding:0 6px}

    
        .box.focus{border-color:rgba(245,158,11,.9);background:rgba(245,158,11,.10)}
    .box.focus h4{color:rgba(245,158,11,1)}

    /* Controles inicio */
    .field{display:flex;flex-direction:column;gap:6px;min-width:220px}
    .lbl{font-size:12px;color:var(--muted)}
    .sel,.inp{background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--txt);border-radius:12px;padding:10px 12px}

    /* Fix: opciones del <select> (en algunos navegadores el desplegable es claro y el texto heredado se ve “en blanco”) */
    .sel option, .sel optgroup{
      color:#0b1220;
      background:#ffffff;
    }

    .inp{width:100%}
    .sel:focus,.inp:focus{outline:2px solid rgba(99,102,241,.45);outline-offset:2px}
    .teamBar{margin:10px 0 0;display:flex;gap:8px;flex-wrap:wrap}
    .teamChip{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .teamChip b{color:var(--txt);font-weight:700}
    .teamChip.active{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.08)}
    .btn[disabled]{opacity:.55;pointer-events:none}
    /* Repregunta */
    .followUp{margin-top:10px;border-top:1px dashed var(--line);padding-top:10px}
    .fuGrid{display:grid;gap:8px;margin-top:8px}
    .fuBtn{text-align:left;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--txt);border-radius:14px;padding:10px 12px}
    .fuBtn:hover{background:rgba(255,255,255,.05)}
    .fuNote{margin:8px 0 0;color:var(--muted);font-size:12px}
    /* Ordena */
    .orderList{margin-top:10px;display:grid;gap:10px}
    .cardItem{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:16px;padding:12px;cursor:grab;user-select:none}
    .cardItem:active{cursor:grabbing}
    .cardItem.dragging{opacity:.6}
    .cardItem small{display:block;color:var(--muted);margin-bottom:6px}
    /* Resultado */
    .teamBoard{display:grid;gap:8px;margin-top:10px}
    .teamRow{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:14px;padding:10px 12px}
    .teamRow .name{font-weight:800}
    .teamRow .pts{color:var(--muted)}
    .plan{margin-top:10px;display:grid;gap:10px}
    .planBox{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:16px;padding:12px}
    .planBox h4{margin:0 0 8px;font-size:14px}
    .planBox ul{margin:0;padding-left:18px;color:var(--muted);line-height:1.45}
    .copyOk{margin-top:8px;color:rgba(34,197,94,1);font-size:12px}
    /* Diagrama */
    .box.decision{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.08)}
    .box.emergency{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.08)}

  
.btn.danger{
  border-color: rgba(255,70,70,.55);
  background: linear-gradient(180deg, rgba(255,70,70,.20), rgba(255,70,70,.08));
}
.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:flex; align-items:center; justify-content:center;
  padding:18px; z-index:50;
}
.modal{
  width:min(760px, 96vw);
  border:1px solid var(--line);
  border-radius:18px;
  background:linear-gradient(180deg, rgba(15,26,51,.96), rgba(11,18,32,.96));
  box-shadow: var(--shadow);
  padding:14px;
}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:720px){ .grid2{grid-template-columns:1fr} }

.mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px; line-height:1.35;
  white-space:pre-wrap;
  color:var(--txt);
}

.checkList{margin-top:10px;display:grid;gap:10px}
.checkItem{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  color:var(--txt);
  border-radius:14px;
  padding:10px 12px;
  cursor:pointer;
  text-align:left;
}
.checkItem:hover{background:rgba(255,255,255,.05)}
.checkItem.on{
  border-color: rgba(46,234,123,.55);
  background: rgba(46,234,123,.10);
}


    /* --- Multijugador (sala) --- */
    .roomBox{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:10px;padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.02)}
    .roomCode{font-weight:800;letter-spacing:3px;font-size:22px}
    .roomMeta{display:flex;flex-direction:column;gap:4px}
    .roomLink{font-size:12px;color:var(--muted);word-break:break-all}
    .qr{width:180px;height:180px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .qr canvas,.qr img{display:block;width:100% !important;height:100% !important}
    .note{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .liveCounts{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .countPill{border:1px solid var(--line);background:rgba(255,255,255,.02);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}


/* MP host: estado "mostrar solución" */
.btn.isActive{ box-shadow: inset 0 0 0 2px rgba(255,255,255,.18); }

/* --- i18n modal --- */
#langModal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:18px; z-index:9999; }
#langModal.hidden{ display:none; }
.langCard{ width:min(560px, 100%); background:var(--panel); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:16px; box-shadow:0 18px 40px rgba(0,0,0,.55); }
.langTitle{ font-size:18px; margin:0 0 6px 0; }
.langBody{ color:var(--muted); font-size:13px; margin:0 0 12px 0; line-height:1.35; }
.langGrid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; }
.langBtn{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--txt); cursor:pointer; text-align:left; }
.langBtn:hover{ background:rgba(255,255,255,.10); }
@media (max-width:520px){ .langGrid{ grid-template-columns:1fr; } .roomBox{flex-direction:column; align-items:center;} .roomMeta{width:100%;} .qr{width:min(70vw,240px); height:min(70vw,240px);} }

</style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <b data-i18n="brand.title">Quién es quién en prevención, un juego simple para conocer las figuras preventivas</b>
      <span data-i18n="brand.subtitle">Actividad rápida: “¿A quién aviso?”</span>
    </div>
    <div class="row" style="gap:10px">
      <select id="langSelect" class="sel small" aria-label="Idioma"></select>
      <button class="btn danger small" id="btnStopWork" type="button">STOP WORK</button>
      <span class="pill" id="pillState">Listo</span>
    </div>
  </div>
</header>

<main>

  <!-- START -->
  <section id="start">

        <div class="card" style="box-shadow:none;border:1px solid var(--line);background:rgba(255,255,255,.02);border-radius:18px;padding:12px;margin-top:12px">
      <div class="row" style="gap:10px;flex-wrap:wrap;align-items:flex-end">
        <label class="field">
          <span class="lbl" data-i18n="label.gameMode">Modo de juego</span>
          <select id="gameMode" class="sel">

<option value="quiz" selected data-i18n="opt.mode.quiz">Preguntas rápidas</option>
<option value="tf" data-i18n="opt.mode.tf">Verdadero / Falso</option>
<option value="order" data-i18n="opt.mode.order">Ordena la actuación</option>
<option value="sema" data-i18n="opt.mode.sema">Semáforo (5 s)</option>
<option value="check" data-i18n="opt.mode.check">Checklist express</option>
<option value="myth" data-i18n="opt.mode.myth">Frase trampa</option>
<option value="say" data-i18n="opt.mode.say">¿Qué le digo al mando?</option>
          </select>
        </label>

        <label class="field">
          <span class="lbl" data-i18n="label.playMode">Participación</span>
          <select id="playMode" class="sel">
            <option value="solo" selected data-i18n="opt.play.solo">Individual</option>
            <option value="teams" data-i18n="opt.play.teams">Equipos</option>
          </select>
        </label>

        
        

        <label class="field">
          <span class="lbl" data-i18n="label.sessionMode">Sala (móviles)</span>
          <select id="sessionMode" class="sel">
            <option value="local" selected data-i18n="opt.session.local">Sin sala</option>
            <option value="host" data-i18n="opt.session.host">Crear sala (host)</option>
            <option value="join" data-i18n="opt.session.join">Unirme (móvil)</option>
          </select>
        </label>

        <div id="hostWrap" class="hidden" style="flex:1 1 100%;min-width:260px">
          <div class="roomBox" id="roomBox">
            <div class="roomMeta">
              <div class="lbl">Código de sala</div>
              <div class="roomCode" id="roomCode">—</div>
              <div class="roomLink" id="roomLink"></div>
            

              <div class="note" id="roomNote" data-i18n="room.note">Crea la sala, deja que entren, y luego pulsa “Empezar” otra vez para lanzar la partida.</div>
            </div>
            <div class="qr" id="roomQr" aria-label="QR de unión"></div>
          </div>
          <div class="row" style="gap:10px;margin-top:10px;justify-content:flex-end">
            <button class="btn" id="btnCloseRoom" type="button" data-i18n="btn.closeRoom">Cerrar sala</button>
          </div>
        </div>

        <div id="joinWrap" class="hidden" style="flex:1 1 100%;min-width:260px">
          <div class="row" style="gap:10px;flex-wrap:wrap;align-items:flex-end">
            <label class="field" style="min-width:220px">
              <span class="lbl" data-i18n="label.roomCode">Código de sala</span>
              <input id="joinCode" class="inp" placeholder="Ej: 123456" data-i18n-placeholder="ph.joinCode" inputmode="numeric" maxlength="6"/>
            </label>
            <label class="field" style="min-width:220px">
              <span class="lbl" data-i18n="label.nameOptional">Nombre (opcional)</span>
              <input id="joinName" class="inp" placeholder="Ej: Mario" data-i18n-placeholder="ph.joinName"/>
            </label>
          </div>
          <div class="row" style="gap:10px;margin-top:10px;justify-content:flex-end">
            <button class="btn primary" id="btnJoinRoom" type="button" data-i18n="btn.joinRoom">Unirme</button>
          </div>
          <div class="note" id="joinNote" data-i18n="mp.joinTip">Tip: si entras desde un QR, el código se rellena solo.</div>
        </div>
<label class="field" id="quizPaceWrap">
          <span class="lbl" data-i18n="label.pace">Ritmo</span>
          <select id="quizPace" class="sel">
            <option value="normal" selected data-i18n="opt.pace.normal">Normal (con repregunta)</option>
            <option value="fast" data-i18n="opt.pace.fast">Rápido (sin repregunta)</option>
          </select>
        </label>

        <label class="field">
          <span class="lbl" data-i18n="label.bg">Fondo</span>
          <select id="bgTheme" class="sel">
            <option value="night" selected>Noche</option>
            <option value="graphite">Grafito</option>
            <option value="slate">Pizarra</option>
            <option value="forest">Bosque</option>
            <option value="sand">Arena</option>
          </select>
        </label>
<label class="field hidden" id="teamCountWrap">
          <span class="lbl" data-i18n="label.nTeams">Nº equipos</span>
          <select id="teamCount" class="sel">
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </label>
      </div>

      <div id="teamNames" class="hidden" style="margin-top:10px;display:grid;gap:8px"></div>
      <small id="modeHelp" style="display:block;margin-top:10px;color:var(--muted);line-height:1.35">—</small>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnStart" data-i18n="btn.start">Empezar</button>
            <button class="btn" id="btnReset" data-i18n="btn.reset">Reiniciar</button>
    </div>
</section>

  <!-- QUIZ -->
  

  <!-- Waiting room (player side) -->
  <section id="waiting" class="card hidden">
    <h2 data-i18n="mp.waitTitle">En sala</h2>
    <p class="muted" data-i18n="mp.waitSubtitle">Esperando a que el host inicie la partida…</p>
    <div class="row" style="margin-top:14px; gap:10px; flex-wrap:wrap;">
      <span class="pill" id="waitingRoom">—</span>
      <span class="pill" id="waitingPlayers">—</span>
    </div>
    <p class="muted" style="margin-top:10px;" data-i18n="mp.waitHint">Cuando empiece la partida, aquí aparecerán las preguntas.</p>
  </section>

<section id="quiz" class="card hidden">
    <div class="meta">
      <div class="row" style="gap:8px">
        <span class="pill" id="qCounter">Pregunta 1/1</span>
        <span class="pill" id="qScore">Puntos: 0</span>
        <span class="pill hidden" id="qTimer">⏱ 5</span>
      </div>
      <div class="progress" aria-label="Progreso del cuestionario">
        <div class="bar" id="bar"></div>
      </div>
    </div>

    <div class="teamBar hidden" id="teamBar"></div>

    <h3 class="qtitle" id="qText">—</h3>
    <p class="qsub" id="qHint">—</p>

    <div class="answers" id="answers"></div>

    <div class="liveCounts hidden" id="liveCounts"></div>

    <div id="orderArea" class="hidden">
      <p class="qsub" id="orderInstr" style="margin-top:10px">Arrastra las tarjetas para ordenar la actuación (de primero a último).</p>
      <div class="orderList" id="orderList"></div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn" id="btnCheckOrder" type="button">Comprobar</button>
      </div>
    
<div id="checkArea" class="hidden">
  <p class="qsub" id="checkInstr" style="margin-top:10px">Elige los 3 imprescindibles antes de empezar. (0/3)</p>
  <div class="checkList" id="checkList"></div>
  <div class="row" style="margin-top:12px;justify-content:flex-end">
    <button class="btn" id="btnCheckChecklist" type="button">Comprobar</button>
  </div>
</div>

</div>


    <div id="feedback" class="feedback hidden">
      <b id="fbTitle">—</b>
      <p id="fbBody">—</p>

      <div id="followUp" class="followUp hidden">
        <b>Repregunta (para fijarlo)</b>
        <p id="fuQ" style="margin:6px 0 0;color:var(--muted)">—</p>
        <div class="fuGrid" id="fuAnswers"></div>
        <div class="fuNote" id="fuNote"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn" id="btnBackToStart" data-i18n="btn.back">Salir</button>
      <div class="row" style="gap:10px">
        <button class="btn hidden" id="btnReveal" type="button" data-i18n="btn.reveal">Mostrar solución</button>
        <button class="btn primary hidden" id="btnNext" data-i18n="btn.next">Siguiente</button>
      </div>
    </div>
  </section>

  <!-- RESULT -->
  <section id="result" class="card hidden">
    <div class="split">
      <div class="card" style="box-shadow:none">
        <h2 style="margin:0 0 6px" data-i18n="result.title">Resultado</h2>
        <p class="scoreBig" id="finalScore">0</p>
        <p style="margin:0;color:var(--muted)" id="finalDetail">—</p>
        <div id="teamBoard" class="teamBoard hidden"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnAgain" data-i18n="result.btnAgain">Repetir</button>
          <button class="btn" id="btnToStart" data-i18n="result.btnToStart">Volver al inicio</button>
        </div>

        <div class="list" id="breakdown"></div>
      </div>

      <div class="card" style="box-shadow:none">

        <h3 style="margin:0 0 8px" data-i18n="diagram.title">Diagrama de orden (a quién escalar)</h3>
        
        <div class="diagram">
          <div class="flow" aria-label="Diagrama de orden de comunicación en PRL">
            <div class="box" id="boxTrabajador">
              <h4 data-i18n="diagram.worker.h">1) Trabajador/a</h4>
              <p data-i18n="diagram.worker.p">Detecta el riesgo / suceso y lo comunica.</p>
            </div>
            <div class="arrow">→</div>
            <div class="box decision" id="boxDecision">
              <h4 data-i18n="diagram.decision.h">2) ¿Es grave / hay lesión?</h4>
              <p data-i18n="diagram.decision.p">Si hay lesión o riesgo grave e inminente, prioriza emergencia.</p>
            </div>
            <div class="arrow">→</div>
            <div class="box emergency" id="boxEmergencia">
              <h4 data-i18n="diagram.emergency.h">3) Emergencia (112)</h4>
              <p data-i18n="diagram.emergency.p">Asegura la zona, pide ayuda y después informa por la vía interna.</p>
            </div>
          </div>

          <div class="flow">
            <div class="box" id="boxMando">
              <h4 data-i18n="diagram.mando.h">4) Mando directo</h4>
              <p data-i18n="diagram.mando.p">Encargado/Jefe de equipo/Jefe de obra. Canal principal cuando está disponible.</p>
            </div>
            <div class="arrow">→</div>
            <div class="box" id="boxRecurso">
              <h4 data-i18n="diagram.recurso.h">5) Recurso Preventivo</h4>
              <p data-i18n="diagram.recurso.p">Vía rápida en obra si el mando no está localizable o para temas menores/reincidencias. Deja constancia preventiva.</p>
            </div>
            <div class="arrow">→</div>
            <div class="box" id="boxTecnico">
              <h4 data-i18n="diagram.tecnico.h">6) Técnico PRL / Servicio de Prevención</h4>
              <p data-i18n="diagram.tecnico.p">Procesos de prevención: procedimientos, formación, EPIs, sustancias, consultas técnicas.</p>
            </div>
          </div>

          <div class="flow">
            <div class="box" id="boxCSS">
              <h4 data-i18n="diagram.css.h">7) CSS</h4>
              <p data-i18n="diagram.css.p">Interferencias entre contratas y coordinación de actividades en obra.</p>
            </div>
            <div class="arrow">→</div>
            <div class="box" id="boxDelegado">
              <h4 data-i18n="diagram.delegado.h">8) Delegado/a de prevención</h4>
              <p data-i18n="diagram.delegado.p">Canal de participación y propuestas. No sustituye avisos urgentes al mando.</p>
            </div>
          </div>
        </div>
</div>
        <p style="margin:10px 0 0;color:var(--muted);font-size:12px" data-i18n="result.emergencyNote">
          En situaciones graves: activar emergencia (ej. 112) cuando proceda y después informar por la vía interna.
        </p>

        
        <h3 style="margin:14px 0 8px" data-i18n="result.recoTitle">Recomendaciones según tu puntuación</h3>
        <div id="actionPlan" class="plan"></div>
        <div class="row" style="margin-top:10px;gap:10px">
          <button class="btn" id="btnCopyPlan" type="button" data-i18n="plan.btnCopy">Copiar plan</button>
          <span id="copyOk" class="copyOk hidden" data-i18n="plan.copied">✅ Plan copiado</span>
        </div>

      </div>
    </div>
  </section>
</main>


<div id="stopWorkOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-label="Stop Work">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px">
      <div>
        <h3 style="margin:0 0 6px" data-i18n="sw.title">STOP WORK · Parada segura</h3>
        <p style="margin:0;color:var(--muted);line-height:1.35;font-size:13px" data-i18n-html="sw.body">Úsalo si hay <b>riesgo grave e inminente</b>, ausencia/fallo de protección colectiva, o interferencias peligrosas.
          Primero <b>asegura</b> la zona; después <b>comunica</b>.</p>
      </div>
      <button class="btn small" id="btnCloseStop" type="button" data-i18n="sw.btnClose">Cerrar</button>
    </div>

    <div class="grid2" style="margin-top:12px">
      <label class="field">
        <span class="lbl" data-i18n="sw.lbl.loc">Ubicación exacta</span>
        <input class="inp" id="swLoc" type="text" data-i18n-placeholder="sw.ph.loc" placeholder="Ej.: Planta 2, ala norte, junto al hueco de escalera">
      </label>
      <label class="field">
        <span class="lbl" data-i18n="sw.lbl.risk">Qué pasa (riesgo)</span>
        <input class="inp" id="swRisk" type="text" data-i18n-placeholder="sw.ph.risk" placeholder="Ej.: Hueco sin barandilla / cables sueltos / izado sin balizar">
      </label>
    </div>

    <div class="grid2" style="margin-top:10px">
      <label class="field">
        <span class="lbl" data-i18n="sw.lbl.control">Medida provisional aplicada</span>
        <input class="inp" id="swControl" type="text" data-i18n-placeholder="sw.ph.control" placeholder="Ej.: He parado la tarea y he señalizado/aislado">
      </label>
      <label class="field">
        <span class="lbl" data-i18n="sw.lbl.need">Qué necesitas ahora</span>
        <input class="inp" id="swNeed" type="text" data-i18n-placeholder="sw.ph.need" placeholder="Ej.: Que venga el mando/recurso para corregir y dejar constancia">
      </label>
    </div>

    <div class="card" style="margin-top:12px;box-shadow:none;background:rgba(255,255,255,.03)">
      <small style="display:block;color:var(--muted);margin-bottom:6px" data-i18n="sw.msgReady">Mensaje listo para enviar (mando / recurso / CSS):</small>
      <div class="mono" id="swMsg">—</div>
      <div class="row" style="margin-top:10px;gap:10px">
        <button class="btn primary" id="btnCopyStop" type="button" data-i18n="sw.btnCopy">Copiar mensaje</button>
        <span id="swCopied" class="copyOk hidden" data-i18n="sw.copied">✅ Copiado</span>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

<script type="module">
  // Puente Firebase (carga bajo demanda). Basado en la guía oficial de CDN (Web SDK setup alternatives).
  // Versión fijada para evitar cambios inesperados.
  const SDK_VER = "12.9.0";
  let cached = null;

  window.__getFirebase = async function(firebaseConfig){
    if (cached) return cached;
    if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("REEMPLAZA")){
      throw new Error("Falta configurar firebaseConfig (apiKey, databaseURL, etc.).");
    }
    const appMod = await import(`https://www.gstatic.com/firebasejs/${SDK_VER}/firebase-app.js`);
    const dbMod  = await import(`https://www.gstatic.com/firebasejs/${SDK_VER}/firebase-database.js`);

    const app = appMod.initializeApp(firebaseConfig);
    const db  = dbMod.getDatabase(app);

    cached = { app, db, ...dbMod };
    return cached;
  };
</script>

<script>
// ---------------- I18N (UI + question translations) ----------------
const I18N = {
  lang: "es",
  ui: {},
  q: {} // structure: { quiz: { "1": {q,hint,answers:[...],why:[...] } } }
};

const LANGS = [
  { code:"es", label:"Español", dir:"ltr" },
  { code:"en", label:"English", dir:"ltr" },
  { code:"fr", label:"Français", dir:"ltr" },
  { code:"ro", label:"Română", dir:"ltr" },
  { code:"zh", label:"中文", dir:"ltr" },
  { code:"ar", label:"العربية", dir:"rtl" }
];
function t(key, fallback){
  try{
    const v = (I18N && I18N.ui) ? I18N.ui[key] : null;
    return (typeof v === "string" && v.length) ? v : fallback;
  }catch(_e){ return fallback; }
}


function uiAny(key, fallback){
  try{
    const v = (I18N && I18N.ui) ? I18N.ui[key] : undefined;
    return (v !== undefined && v !== null) ? v : fallback;
  }catch(_e){ return fallback; }
}


function fmt(template, vars){
  if (typeof template !== "string") return "";
  return template.replace(/\{(\w+)\}/g, (_m,k)=> (vars && (k in vars)) ? String(vars[k]) : "");
}

function detectLang(){
  const sp = new URLSearchParams(location.search);
  const urlLang = (sp.get("lang") || "").toLowerCase();
  if (urlLang) return urlLang;
  const stored = (localStorage.getItem("lang") || "").toLowerCase();
  if (stored) return stored;
  const nav = (navigator.language || "es").toLowerCase();
  if (nav.startsWith("fr")) return "fr";
  if (nav.startsWith("ro")) return "ro";
  if (nav.startsWith("ar")) return "ar";
  if (nav.startsWith("zh")) return "zh";
  if (nav.startsWith("en")) return "en";
  return "es";
}

function currentLang(){
  // Fuente única de verdad del idioma actual.
  // Prioridad: selector UI -> I18N.lang -> detectLang()
  const sel = document.getElementById("langSelect");
  const v = (sel && sel.value) ? String(sel.value).toLowerCase() : "";
  return (v || (I18N && I18N.lang) || detectLang() || "es").toLowerCase();
}


function setDocLang(lang){
  const meta = LANGS.find(x=>x.code===lang) || LANGS[0];
  document.documentElement.lang = meta.code;
  document.documentElement.dir  = meta.dir || "ltr";
}

function substSiteName(s){
  if (typeof s !== "string") return s;
  try{
    const sn = (typeof SITE_NAME !== "undefined") ? SITE_NAME : "";
    return s.replaceAll("{SITE_NAME}", sn).replaceAll("${SITE_NAME}", sn);
  }catch(_e){ return s; }
}

function baseDirUrl(){
  // Base directory URL for GitHub Pages quirks:
  // - https://user.github.io/repo        (no trailing slash)  -> treat as /repo/
  // - https://user.github.io/repo/       -> /repo/
  // - https://user.github.io/repo/index.html -> /repo/
  const u = new URL(location.href);
  u.hash = "";
  u.search = "";
  const p = u.pathname || "/";
  if (p.endsWith("/")) return u.origin + p;
  // if ends with extension (e.g., .html) -> use directory
  if (/\.[a-z0-9]+$/i.test(p)) return u.origin + p.substring(0, p.lastIndexOf("/") + 1);
  // otherwise treat as directory
  return u.origin + p + "/";
}

function projectRootUrl(){
  // Root for assets (i18n/*) when the HTML is served from a subfolder (e.g. /repo/in/).
  // On GitHub Pages project sites: https://user.github.io/<repo>/... -> root is /<repo>/
  const u = new URL(location.href);
  u.hash = ""; u.search = "";
  const parts = (u.pathname || "/").split("/").filter(Boolean);
  const host = (u.hostname || "").toLowerCase();
  if (host.endsWith("github.io") && parts.length >= 1){
    return u.origin + "/" + parts[0] + "/";
  }
  // Fallback: assume site root
  return u.origin + "/";
}
const BASE_DIR_URL = baseDirUrl();
const PROJECT_ROOT_URL = projectRootUrl();

async function fetchJson(path){
  const r = await fetch(path, { cache:"no-store" });
  if (!r.ok) throw new Error("HTTP " + r.status);
  return await r.json();
}

async function loadUi(lang){
  // fallback chain: lang -> es -> {}
  const bases = [BASE_DIR_URL, PROJECT_ROOT_URL].filter((v,i,a)=>v && a.indexOf(v)===i);
  const langs = [lang, (lang==="es"?null:"es")].filter(Boolean);
  for (const b of bases){
    for (const l of langs){
      try{ return await fetchJson(`${b}i18n/ui/${l}.json`); }catch(_e){}
    }
  }
  return {};
}

async function loadQ(lang){
  // Intenta cargar el pack de preguntas en varios formatos/rutas (para evitar "preguntas siempre en ES").
  const clean = (lang || "es").toLowerCase();
  const bases = [BASE_DIR_URL, PROJECT_ROOT_URL].filter((v,i,a)=>v && a.indexOf(v)===i);
  const patterns = [
    (b)=> `${b}i18n/questions/${clean}.json`,      // ruta preferida
    (b)=> `${b}i18n/q/${clean}.json`,              // alternativa
    (b)=> `${b}i18n/questions_${clean}.json`,      // alternativa
    (b)=> `${b}i18n/${clean}/questions.json`,      // alternativa
    (b)=> `${b}i18n/questions.json`,               // pack único
    (b)=> `${b}i18n/questions/all.json`            // pack único
  ];
  const tries = [];
  for (const b of bases){ for (const p of patterns){ tries.push(p(b)); } }

  for (const url of tries){
    try{
      const obj = await fetchJson(url);
      if (obj && typeof obj === "object" && Object.keys(obj).length){
        try{ obj.__src = url; }catch(_e){}
        return obj;
      }
    }catch(_e){}
  }

  // fallback a ES si el idioma no existe
  if (clean !== "es"){
    try{
      const obj = await fetchJson(`${BASE_DIR_URL}i18n/questions/es.json`).catch(()=>fetchJson(`${PROJECT_ROOT_URL}i18n/questions/es.json`));
      if (obj && typeof obj === "object") return obj;
    }catch(_e){}
  }
  return {};
}

function applyUi(){
  // text nodes
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    const val = I18N.ui[key];
    if (typeof val === "string") el.textContent = val;
  });

  // innerHTML nodes (use only for trusted local strings)
  document.querySelectorAll("[data-i18n-html]").forEach(el=>{
    const key = el.getAttribute("data-i18n-html");
    const val = I18N.ui[key];
    if (typeof val === "string") el.innerHTML = val;
  });

  // placeholders
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const key = el.getAttribute("data-i18n-placeholder");
    const val = I18N.ui[key];
    if (typeof val === "string") el.setAttribute("placeholder", val);
  });

  // <option> text
  document.querySelectorAll("option[data-i18n]").forEach(opt=>{
    const key = opt.getAttribute("data-i18n");
    const val = I18N.ui[key];
    if (typeof val === "string") opt.textContent = val;
  });

  // language select labels
  const sel = document.getElementById("langSelect");
  if (sel){
    const prev = sel.value || I18N.lang;
    sel.innerHTML = "";
    LANGS.forEach(l=>{
      const o = document.createElement("option");
      o.value = l.code;
      o.textContent = l.label;
      sel.appendChild(o);
    });
    sel.value = prev;
  }
}
function getQBank(bankKey){
  // Soporta distintos "wrappers" dentro del JSON de preguntas.
  // También soporta packs donde el root YA es un mapa id->tr (sin "quiz"/"tf" encima),
  // y también packs que sean ARRAY de entradas (p.e. [{id:1,q:"...",answers:[...]}]).
  const q = (I18N && I18N.q) ? I18N.q : {};

  // pack como array
  if (Array.isArray(q)) return q;

  // wrappers típicos
  const cand = (q && (q[bankKey] || q.questions?.[bankKey] || q.banks?.[bankKey] || q.bank?.[bankKey] || q.data?.[bankKey])) || null;
  if (cand) return cand;

  // a veces viene como q.questions (mapa id->tr) sin bankKey
  if (q && q.questions && typeof q.questions === "object" && !Array.isArray(q.questions)){
    const keys = Object.keys(q.questions);
    if (keys.length && keys.some(k => /^\d+$/.test(k))) return q.questions;
  }

  // root mapa id->tr
  try{
    const keys = q ? Object.keys(q) : [];
    const looksNumeric = keys.length && keys.some(k => /^\d+$/.test(k));
    if (looksNumeric) return q;
  }catch(_e){}
  return null;
}

function applyQTranslation(bankKey, q){
  if (!q || q.id == null) return q;

  const bank = getQBank(bankKey);
  if (!bank) return q;

  const tr = bank[String(q.id)];
  if (!tr) return q;

  // básicos
  if (typeof tr.q === "string")    q.q    = substSiteName(tr.q);
  if (typeof tr.hint === "string") q.hint = substSiteName(tr.hint);
  if (typeof tr.topic === "string") q.topic = substSiteName(tr.topic);

  // ---------- ORDER (drag) ----------
  if (Array.isArray(q.steps)){
    const trSteps = Array.isArray(tr.steps) ? tr.steps : (Array.isArray(tr.options) ? tr.options : null);
    if (trSteps){
      trSteps.forEach((s, i)=>{
        if (typeof s === "string" && q.steps[i] != null){
          q.steps[i] = substSiteName(s);
        }
      });
    }
    if (typeof tr.why === "string"){
      q.why = substSiteName(tr.why);
    }
  }

  // ---------- CHECKLIST ----------
  if (Array.isArray(q.items)){
    const trItems = Array.isArray(tr.items) ? tr.items : (Array.isArray(tr.options) ? tr.options : null);
    if (trItems){
      trItems.forEach((s, i)=>{
        if (typeof s === "string" && q.items[i] != null){
          q.items[i] = substSiteName(s);
        }
      });
    }
    if (typeof tr.whyGreen === "string") q.whyGreen = substSiteName(tr.whyGreen);
    if (typeof tr.whyAmber === "string") q.whyAmber = substSiteName(tr.whyAmber);
    if (typeof tr.whyRed   === "string") q.whyRed   = substSiteName(tr.whyRed);
  }

  // ---------- MCQ (quiz/tf/sema/myth/say) ----------
  const ansArr = Array.isArray(q.answers) ? q.answers : (Array.isArray(q.a) ? q.a : null);
  const trAnsRaw = Array.isArray(tr.answers) ? tr.answers : (Array.isArray(tr.a) ? tr.a : (Array.isArray(tr.options) ? tr.options : null));
  const trWhyArr = Array.isArray(tr.why) ? tr.why : (Array.isArray(tr.rationale) ? tr.rationale : (Array.isArray(tr.explain) ? tr.explain : null));

  if (ansArr && trAnsRaw && trAnsRaw.length){
    // Si la traducción viene como [{aid, txt, why}, ...], creamos un lookup por aid
    const hasAidObj = trAnsRaw.some(it => it && typeof it === "object" && (it.aid != null || it.id != null || it.idx != null));
    const trMapByAid = new Map();
    if (hasAidObj){
      trAnsRaw.forEach((it, idx)=>{
        if (it && typeof it === "object"){
          const aid = (it.aid != null) ? it.aid : ((it.id != null) ? it.id : ((it.idx != null) ? it.idx : idx));
          trMapByAid.set(Number(aid), it);
        }
      });
    }

    ansArr.forEach((ans, idx)=>{
      if (!ans) return;

      const aid = (ans && typeof ans === "object" && ans.__aid != null) ? Number(ans.__aid) : idx;

      const trItem = hasAidObj ? (trMapByAid.get(aid) || trAnsRaw[aid]) : trAnsRaw[aid];

      // Texto
      if (typeof trItem === "string"){
        if (ans && typeof ans === "object") ans.txt = substSiteName(trItem);
      } else if (trItem && typeof trItem === "object"){
        const rawTxt =
          (typeof trItem.txt === "string") ? trItem.txt :
          (typeof trItem.text === "string") ? trItem.text :
          (typeof trItem.label === "string") ? trItem.label :
          null;

        const rawWhy =
          (typeof trItem.why === "string") ? trItem.why :
          (typeof trItem.explain === "string") ? trItem.explain :
          (typeof trItem.rationale === "string") ? trItem.rationale :
          null;

        if (rawTxt && rawTxt.trim().length && ans && typeof ans === "object") ans.txt = substSiteName(rawTxt);
        if (rawWhy && rawWhy.trim().length && ans && typeof ans === "object") ans.why = substSiteName(rawWhy);
      }

      // Por si el "why" viene separado
      if (trWhyArr && typeof trWhyArr[aid] === "string" && trWhyArr[aid].trim().length){
        if (ans && typeof ans === "object") ans.why = substSiteName(trWhyArr[aid]);
      }
    });

    // asegura __aid si no existía
    ansArr.forEach((a, i)=>{
      if (a && typeof a === "object" && a.__aid == null) a.__aid = i;
    });

    if (Array.isArray(q.answers)) q.answers = ansArr;
    else if (Array.isArray(q.a)) q.a = ansArr;
  }

  return q;
}


function applyFUTranslation(fu){
  if (!fu || !fu.id) return fu;
  const bank = (I18N.q && I18N.q.fu) ? I18N.q.fu : null;
  if (!bank) return fu;
  const tr = bank[String(fu.id)];
  if (!tr) return fu;

  if (typeof tr.q === "string") fu.q = substSiteName(tr.q);
  if (typeof tr.hint === "string") fu.hint = substSiteName(tr.hint);
  if (typeof tr.ok === "string") fu.ok = substSiteName(tr.ok);
  if (Array.isArray(tr.options) && Array.isArray(fu.options)){
    tr.options.forEach((txt, i)=>{
      if (typeof txt === "string" && fu.options[i] !== undefined) fu.options[i] = substSiteName(txt);
    });
  }
  return fu;
}

async function setLang(lang, persist=true){
  const clean = (lang || "es").toLowerCase();
  I18N.lang = LANGS.some(x=>x.code===clean) ? clean : "es";
  setDocLang(I18N.lang);
  if (persist){ try{ localStorage.setItem("lang", I18N.lang); }catch(_e){} }

  I18N.ui = await loadUi(I18N.lang);
  I18N.q  = await loadQ(I18N.lang);

  applyUi();

  // Re-render de la vista activa para aplicar traducciones (UI + preguntas) al vuelo
  try{
    if (I18N && I18N.lang !== "es" && (!I18N.q || !Object.keys(I18N.q).length)){
      console.warn("No se cargó pack de preguntas para", I18N.lang, "(revisa i18n/questions).", (I18N.q && I18N.q.__src) ? I18N.q.__src : "");
    }
  }catch(_e){}

  try{ rerenderActiveView(); }catch(_e){}
}

function rerenderActiveView(){
  // Re-render mínimo para aplicar traducciones sin resetear toda la app.
  try{
    // Multijugador: repinta según phase actual
    if (typeof MP !== "undefined" && (MP.role === "host" || MP.role === "join") && MP.current){
      handleStateChange(MP.current);
      return;
    }
  }catch(_e){}

  try{
    const quizEl = document.getElementById("quiz");
    const isQuizVisible = quizEl && !quizEl.classList.contains("hidden");
    if (!isQuizVisible) return;

    // Local (MCQ): repinta la pregunta actual
    if (typeof renderQuestion === "function" && typeof gameMode === "string"){
      if (["quiz","tf","sema","myth","say"].includes(gameMode)){
        renderQuestion(gameMode);
      }
    }
  }catch(_e){}
}

function openLangModal(onPick){
  const modal = document.getElementById("langModal");
  const grid  = document.getElementById("langGrid");
  if (!modal || !grid){ onPick && onPick(detectLang()); return; }
  grid.innerHTML = "";
  LANGS.forEach(l=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "langBtn";
    b.textContent = l.label;
    b.addEventListener("click", async ()=>{
      modal.classList.add("hidden");
      await setLang(l.code, true);
      if (typeof onPick === "function") onPick(l.code);
    });
    grid.appendChild(b);
  });
  modal.classList.remove("hidden");
}

// promise to wait i18n ready
let __i18nReadyResolve;
window.__i18nReady = new Promise(res=>{ __i18nReadyResolve = res; });

// init i18n at DOM ready (before MP autostart)
window.addEventListener("DOMContentLoaded", async ()=>{
  const initial = detectLang();
  await setLang(initial, true);
  const sel = document.getElementById("langSelect");
  if (sel){
    sel.value = I18N.lang;
    sel.addEventListener("change", async ()=>{ await setLang(sel.value, true); });
  }
  __i18nReadyResolve && __i18nReadyResolve();
});


/**
 * Enanos Espaciales · Kahoot PRL (web) — v8
 * Política didáctica (resumen):
 * - Canal principal: Mando (encargado/jefe de obra) cuando está disponible.
 * - Si el mando NO está localizable y es un tema menor/reincidencia → Recurso Preventivo.
 * - Procesos/consultas de prevención (procedimiento, formación, EPIs, sustancias...) → Técnico PRL / Servicio de Prevención.
 * - Interferencias entre contratas → CSS.
 * - Propuestas/participación → Delegado/a de prevención.
 *
 * Juego:
 * - 25 casos
 * - Preguntas SIEMPRE aleatorias
 * - Respuestas SIEMPRE aleatorias
 * - Verde=2 · Naranja=1 · Roja=0
 */

const SITE_NAME = "Turrón Prevención";
const ROLE_ORDER = ["mando","recurso","tecnico","css","delegado","emergencia"];
const ROLE_LABEL = {
  mando: "Mando (encargado/jefe de obra)",
  recurso: "Recurso preventivo (obra)",
  tecnico: "Técnico PRL / Servicio de Prevención",
  css: "CSS (Coordinador/a de Seguridad y Salud)",
  delegado: "Delegado/a de prevención",
  emergencia: "Emergencia (112)"
};
const ROLE_BOX_ID = {
  mando: "boxMando",
  recurso: "boxRecurso",
  tecnico: "boxTecnico",
  css: "boxCSS",
  delegado: "boxDelegado",
  emergencia: null
};

const QUESTIONS_BASE = [
  // 1) Orden y limpieza (pequeño: si mando no está, recurso es lo más rápido)
  {
    id: 1,
    bestRole: "recurso",
    q: `En ${SITE_NAME}, ves una zona desorganizada (herramientas/materiales por el suelo) y el mando no está localizable en ese momento. ¿A quién avisas?`,
    hint: "Tema menor/operativo con mando no disponible.",
    answers: [
      { txt: "Al recurso preventivo (obra).", grade: "green",
        why: "Vía rápida en obra para activar corrección cuando el mando no está disponible." },
      { txt: "A mi mando directo (cuando lo encuentre).", grade: "amber",
        why: "Correcto, pero si no está localizable ahora, el recurso preventivo puede activar la corrección ya." },
      { txt: "A nadie, lo esquivo y sigo.", grade: "red",
        why: "Si no se comunica, el riesgo se repite (tropiezos/caídas)." },
      { txt: "A Chewbacca, que impone el orden wookiee.", grade: "red",
        why: "Los wookies son magníficos tiradores, pero pésimos en PRL.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 2) Caída 5m (grave + emergencia)
  {
    id: 2,
    bestRole: "emergencia",
    q: `En ${SITE_NAME}, ves caer a un compañero desde 5 metros. ¿A quién avisas?`,
    hint: "Accidente grave: emergencia + comunicación interna.",
    answers: [
      { txt: "Al 112 y al mando (encargado/jefe de obra).", grade: "green",
        why: "Emergencia + aviso interno inmediato: es lo más correcto." },
      { txt: "Solo al mando (sin llamar al 112).", grade: "amber",
        why: "Avisar internamente está bien, pero con 5 m lo más seguro es activar 112." },
      { txt: "Lo levanto para que se siente ‘un momento’.", grade: "red",
        why: "Mover a la persona puede empeorar lesiones. Se activa la respuesta adecuada." },
      { txt: "Me espero a ver si se levanta solo.", grade: "red",
        why: "La prioridad es activar respuesta y avisos correctos." }
    ]
  },

  // 3) Viento fuerte (grave/operativo)
  {
    id: 3,
    bestRole: "mando",
    q: `En ${SITE_NAME} hay rachas de viento de 100 km/h. ¿A quién avisas para parar trabajos por condiciones adversas?`,
    hint: "Parada/organización de obra.",
    answers: [
      { txt: "A mi mando directo (encargado/jefe de obra).", grade: "green",
        why: "Puede ordenar parar o reorganizar el trabajo de forma segura." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero quien organiza y ordena la parada es el mando." },
      { txt: "Al promotor para que decida.", grade: "red",
        why: "No es el canal inmediato para una parada por seguridad." },
      { txt: "Que le explique Gandalf el «¡No pasarás!» al viento.", grade: "red",
        why: "Gandalf es un crack, pero no dirige la obra ni puede ordenar la parada.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 4) Chispas (operativo, mando)
  {
    id: 4,
    bestRole: "mando",
    q: `En ${SITE_NAME}, hay un aplique eléctrico mal montado del que saltan chispas. ¿A quién avisas?`,
    hint: "Riesgo eléctrico: aislar y coordinar reparación segura.",
    answers: [
      { txt: "Al mando (encargado/jefe de obra).", grade: "green",
        why: "Organiza la actuación inmediata y la reparación segura." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el mando coordina la respuesta inmediata en el tajo." },
      { txt: "Llamo a Pikachu para que lo arregle con un impactrueno.", grade: "red",
        why: "Pikachu es adorable, pero no está habilitado como electricista de obra.\nLa respuesta correcta en este caso es: {{GREEN}}" },
      { txt: "Lo ajusto yo con un destornillador.", grade: "red",
        why: "Manipular algo que chispea es un riesgo grave." }
    ]
  },

  // 5) Esguince (lesión leve)
  {
    id: 5,
    bestRole: "mando",
    q: `En ${SITE_NAME}, te tuerces el tobillo al resbalar en unas escaleras. ¿A quién avisas?`,
    hint: "Lesión: atención y comunicación interna.",
    answers: [
      { txt: "Al mando y a primeros auxilios.", grade: "green",
        why: "Comunicación interna + atención inmediata: perfecto." },
      { txt: "Solo al mando.", grade: "amber",
        why: "Bien, pero si hay primeros auxilios disponibles, también conviene avisarles." },
      { txt: "Me voy a casa sin decir nada.", grade: "red",
        why: "Hay que comunicar lesiones/incidentes para atender y evitar repetición." },
      { txt: "Sigo trabajando: ‘ya se pasará’.", grade: "red",
        why: "Puedes empeorar la lesión y la causa del resbalón sigue ahí." }
    ]
  },

  // 6) Carga suspendida (grave)
  {
    id: 6,
    bestRole: "mando",
    q: `En ${SITE_NAME}, hay una carga suspendida y gente pasando por debajo. ¿A quién avisas?`,
    hint: "Riesgo grave: maniobra y control inmediato.",
    answers: [
      { txt: "Al mando (encargado/jefe de obra).", grade: "green",
        why: "Debe detener y controlar la maniobra de forma segura." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el canal operativo inmediato es el mando." },
      { txt: "Pido a un Comisario del Astra Militarum que ‘ejecute’ al riesgo.", grade: "red",
        why: "Eso es épico, pero en obra no se purga el riesgo: se comunica y se controla.\nLa respuesta correcta en este caso es: {{GREEN}}" },
      { txt: "Me aparto yo y ya.", grade: "red",
        why: "Si no avisas, el riesgo sigue para otros." }
    ]
  },

  // 7) Reincidencia sin casco (pequeño/reincidente → recurso)
  {
    id: 7,
    bestRole: "recurso",
    q: `En ${SITE_NAME}, ves por tercera vez a la misma cuadrilla trabajando sin casco (ya lo comentaste y no cambió). ¿A quién avisas ahora?`,
    hint: "Reincidencia: refuerzo preventivo y seguimiento.",
    answers: [
      { txt: "Al recurso preventivo (obra) para intervención y seguimiento.", grade: "green",
        why: "Corta la repetición y exige corrección con trazabilidad." },
      { txt: "Al mando directo otra vez.", grade: "amber",
        why: "Correcto, pero si ya no se corrige, lo más eficaz es que intervenga el recurso preventivo." },
      { txt: "Lo ignoro: ‘no es mi empresa’.", grade: "red",
        why: "En obra compartida, comunicar riesgos protege a todos." },
      { txt: "Se lo digo a Dora la Exploradora: ‘¡encuentra el casco!’", grade: "red",
        why: "Dora encuentra cosas, pero eso no gestiona la obra.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 8) Borde sin protección, mando no localizable (recurso)
  {
    id: 8,
    bestRole: "recurso",
    q: `En ${SITE_NAME}, detectas un borde de forjado sin protección colectiva y NO localizas al mando en ese momento. ¿A quién avisas?`,
    hint: "Riesgo crítico + mando no disponible: vía rápida en obra.",
    answers: [
      { txt: "Al recurso preventivo (obra).", grade: "green",
        why: "Está en obra para actuar ante riesgos críticos y activar corrección inmediata." },
      { txt: "Espero a encontrar al mando.", grade: "amber",
        why: "Avisar al mando está bien, pero si no está disponible, hay que activar a quien pueda actuar ya." },
      { txt: "Paso con cuidado y sigo.", grade: "red",
        why: "El riesgo sigue ahí para cualquiera." },
      { txt: "Lo pongo en un post-it y listo.", grade: "red",
        why: "No asegura acción inmediata." }
    ]
  },

  // 9) Casi accidente caída objeto (recurso)
  {
    id: 9,
    bestRole: "recurso",
    q: `En ${SITE_NAME}, cae una herramienta desde altura y por poco golpea a alguien (no hay lesión). ¿A quién avisas?`,
    hint: "Casi accidente: registrar y evitar repetición.",
    answers: [
      { txt: "Al recurso preventivo (obra) para registrar y exigir corrección.", grade: "green",
        why: "Clave para que no se repita: análisis y medidas preventivas." },
      { txt: "Al mando (encargado/jefe de obra).", grade: "amber",
        why: "Correcto, pero el canal preventivo asegura registro y seguimiento del casi accidente." },
      { txt: "A nadie: si no pasó nada, no cuenta.", grade: "red",
        why: "Los casi accidentes se comunican." },
      { txt: "Me pongo a construir una valla tipo Minecraft y ya se arregla.", grade: "red",
        why: "En Minecraft funciona, en obra no.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 10) Cableado en paso, mando no disponible (pequeño → recurso)
  {
    id: 10,
    bestRole: "recurso",
    q: `En ${SITE_NAME}, hay cableado por una zona de paso y la gente tropieza, pero el mando está ocupado/no localizable. ¿A quién avisas?`,
    hint: "Tema menor/operativo con mando no disponible.",
    answers: [
      { txt: "Al recurso preventivo (obra).", grade: "green",
        why: "Puede activar la corrección rápida en obra cuando el mando no está disponible." },
      { txt: "Al mando (cuando lo encuentre).", grade: "amber",
        why: "Correcto, pero si no está localizable ahora, avisa a quien pueda actuar ya." },
      { txt: "Lo salto y sigo.", grade: "red",
        why: "El riesgo permanece para todos." },
      { txt: "Lo enrollo y lo dejo donde sea.", grade: "red",
        why: "Puedes crear otro riesgo. Mejor avisar por el canal." }
    ]
  },

  // 11) Radial sin resguardo (grave, mando)
  {
    id: 11,
    bestRole: "mando",
    q: `En ${SITE_NAME}, ves una radial sin resguardo y un compañero va a usarla. ¿A quién avisas?`,
    hint: "Riesgo inmediato: parar y corregir.",
    answers: [
      { txt: "Al mando (encargado/jefe de obra) para detener y corregir.", grade: "green",
        why: "Debe organizar la parada y la corrección inmediata." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el mando canaliza la corrección inmediata en el tajo." },
      { txt: "Me hago el loco: yo no la voy a usar.", grade: "red",
        why: "Si no lo comunicas, el riesgo sigue." },
      { txt: "Le pongo cinta aislante y arreando.", grade: "red",
        why: "No es una protección adecuada." }
    ]
  },

  // 12) Alarma/humo (grave, mando)
  {
    id: 12,
    bestRole: "mando",
    q: `En ${SITE_NAME}, suena alarma de evacuación o se detecta humo en una zona. ¿A quién avisas?`,
    hint: "Emergencia: seguir instrucciones y avisar.",
    answers: [
      { txt: "Al mando y sigo instrucciones.", grade: "green",
        why: "Comunicación interna y actuación coordinada: perfecto." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el canal inmediato en obra es el mando." },
      { txt: "Voy a mirar de dónde viene el humo.", grade: "red",
        why: "No te expongas: comunica y sigue el procedimiento." },
      { txt: "Sigo trabajando: seguro que es falsa alarma.", grade: "red",
        why: "Ante alarma, se actúa siguiendo instrucciones." }
    ]
  },

  // 13) Procedimiento “raro” (técnico)
  {
    id: 13,
    bestRole: "tecnico",
    q: `En ${SITE_NAME}, te piden una tarea “rara” y no tienes claro el procedimiento seguro (no quieres improvisar). ¿A quién consultas?`,
    hint: "Consulta técnica de prevención.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Aporta criterio técnico preventivo para definir cómo hacerlo seguro." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el técnico PRL suele tener la pauta más completa/documentada." },
      { txt: "A nadie: improviso según me salga.", grade: "red",
        why: "Improvisar en PRL es mala idea." },
      { txt: "Hago lo que me diga el cuñado de WhatsApp.", grade: "red",
        why: "No es un canal técnico fiable." }
    ]
  },

  // 14) Vapores (técnico)
  {
    id: 14,
    bestRole: "tecnico",
    q: `En ${SITE_NAME}, notas vapores fuertes en una zona cerrada y dudas si es seguro seguir trabajando ahí. ¿A quién avisas?`,
    hint: "Exposición: criterio técnico preventivo.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Es el canal técnico para valorar el riesgo y pautar medidas." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el técnico PRL es el soporte más adecuado para valorar exposición." },
      { txt: "Respiro hondo y sigo: ‘si pica, cura’.", grade: "red",
        why: "Exponerse sin evaluar puede ser peligroso." },
      { txt: "Abro una ventana 10 segundos y listo.", grade: "red",
        why: "No garantiza control del riesgo." }
    ]
  },

  // 15) Interferencias contratas (CSS)
  {
    id: 15,
    bestRole: "css",
    q: `En ${SITE_NAME}, ves dos contratas trabajando a la vez en la misma zona y se estorban (riesgo por interferencias). ¿A quién avisas?`,
    hint: "Coordinación de actividades en obra.",
    answers: [
      { txt: "Al coordinador de seguridad y salud (CSS).", grade: "green",
        why: "Figura clave para coordinar interferencias y exigir planificación." },
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "amber",
        why: "Correcto, pero la coordinación de interferencias se gestiona especialmente vía CSS." },
      { txt: "A nadie: que se apañen.", grade: "red",
        why: "Si no se coordina, sube el riesgo de accidente." },
      { txt: "Hago un piedra-papel-tijera entre contratas.", grade: "red",
        why: "Divertido, pero no coordina de verdad." }
    ]
  },

  // 16) Buscar procedimiento antes de empezar (técnico)
  {
    id: 16,
    bestRole: "tecnico",
    q: `En ${SITE_NAME}, quieres informarte de un procedimiento de seguridad (cómo se hace una tarea “bien”) antes de empezar. ¿A quién preguntas?`,
    hint: "Buscar información preventiva antes de actuar.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Es el canal para aclarar procedimiento seguro sin improvisar." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el técnico PRL suele tener la pauta más completa/documentada." },
      { txt: "Lo busco en TikTok y listo.", grade: "red",
        why: "No es una fuente fiable para un procedimiento de obra." },
      { txt: "Hago “speedrun” y ya aprenderé por el camino.", grade: "red",
        why: "Aprender a base de sustos no es prevención.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 17) Propuesta de mejora preventiva (delegado)
  {
    id: 17,
    bestRole: "delegado",
    q: `En ${SITE_NAME}, quieres proponer una mejora preventiva (no urgente) o dar tu opinión para que se tenga en cuenta. ¿A quién se lo trasladas?`,
    hint: "Participación/representación.",
    answers: [
      { txt: "Al delegado/a de prevención.", grade: "green",
        why: "Canal natural para trasladar propuestas y hacer seguimiento desde la representación." },
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "amber",
        why: "Correcto, pero para propuestas y participación, el delegado es un canal muy directo." },
      { txt: "Lo suelto en el grupo de memes y que ‘se haga viral’.", grade: "red",
        why: "No garantiza que se gestione ni se haga seguimiento." },
      { txt: "Lo escribo en una servilleta y la dejo en el bar.", grade: "red",
        why: "No es un canal real de obra.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 18) Dar de baja un EPI dañado (técnico)
  {
    id: 18,
    bestRole: "tecnico",
    q: `En ${SITE_NAME}, detectas que tu EPI está dañado y debe retirarse de uso (“dar de baja”). ¿A quién lo comunicas para tramitarlo como prevención?`,
    hint: "Proceso preventivo (EPI): retirada y gestión.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Es un proceso preventivo: se retira de uso y se gestiona correctamente." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el técnico PRL es el canal más adecuado para tramitarlo como proceso preventivo." },
      { txt: "Lo pego con cinta y digo que está ‘nuevo’.", grade: "red",
        why: "Un EPI dañado se retira de uso: no se “arregla a ojo”." },
      { txt: "Lo dejo por ahí y que lo encuentre el destino.", grade: "red",
        why: "Puede acabar usándolo alguien sin saberlo.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 19) Solicitar formación/instrucciones preventivas (técnico)
  {
    id: 19,
    bestRole: "tecnico",
    q: `En ${SITE_NAME}, vas a hacer una tarea y necesitas formación/instrucciones preventivas (no te han explicado bien). ¿A quién la solicitas?`,
    hint: "Formación y prevención.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Canal preventivo para formación e instrucciones adecuadas." },
      { txt: "Al mando directo.", grade: "amber",
        why: "Correcto, pero el canal preventivo para formación/instrucciones es el técnico PRL." },
      { txt: "A un NPC del juego: “¡Dame la misión y ya!”", grade: "red",
        why: "La prevención no va por misiones, va por procedimiento y formación real." },
      { txt: "Me lo invento: total, ‘siempre se ha hecho así’.", grade: "red",
        why: "Eso es justo lo que provoca sustos.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 20) Producto químico / ficha (técnico)
  {
    id: 20,
    bestRole: "tecnico",
    q: `En ${SITE_NAME}, antes de usar un producto (disolvente/adhesivo/limpiador) quieres saber riesgos y medidas. ¿A quién preguntas?`,
    hint: "Sustancias: consulta preventiva.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Es el canal técnico para orientar sobre riesgos y medidas." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el técnico PRL es el soporte más completo para sustancias." },
      { txt: "A un cómic: ‘si le pasa a Batman, aguanto yo’.", grade: "red",
        why: "No es criterio preventivo real.\nLa respuesta correcta en este caso es: {{GREEN}}" },
      { txt: "Lo huelo fuerte y decido según el mareo.", grade: "red",
        why: "No se evalúa un producto “a nariz”: se consulta." }
    ]
  },

  // 21) Fuera de obra: talla de EPI incorrecta (mando)
  {
    id: 21,
    bestRole: "mando",
    q: `Fuera de obra: te han entregado un EPI pero la talla no es la tuya y necesitas cambio. ¿A quién lo pides primero?`,
    hint: "Gestión operativa de entrega/cambio.",
    answers: [
      { txt: "Al mando (encargado/jefe de obra) para que gestione el cambio.", grade: "green",
        why: "Es el canal operativo para gestionar suministro/cambio de EPI." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero la gestión de suministro normalmente la canaliza el mando." },
      { txt: "Me lo quedo aunque no valga, total ‘cubre algo’.", grade: "red",
        why: "Un EPI que no ajusta bien puede no proteger como debe." },
      { txt: "Me lo cambio con otro sin decir nada.", grade: "red",
        why: "Puede dejar a otra persona sin el EPI correcto.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 22) Fuera de obra: reporte tardío de casi accidente (recurso)
  {
    id: 22,
    bestRole: "recurso",
    q: `Fuera de obra: ayer hubo un casi accidente y hoy quieres comunicarlo para que se registre y no se repita. ¿A quién se lo comunicas?`,
    hint: "Registro preventivo y seguimiento.",
    answers: [
      { txt: "Al recurso preventivo (obra) para registrar y hacer seguimiento.", grade: "green",
        why: "Es el canal preventivo para registrar y activar acciones para que no se repita." },
      { txt: "Al mando directo.", grade: "amber",
        why: "Correcto, pero el recurso preventivo asegura registro y seguimiento del casi accidente." },
      { txt: "A nadie: lo que pasó, pasó.", grade: "red",
        why: "Si no se registra, se repite." },
      { txt: "Lo cuento en modo historia épica", grade: "red",
        why: "Las épicas molan, pero hay que comunicar por el canal real.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  },

  // 23) Fuera de obra: propuesta formal (delegado)
  {
    id: 23,
    bestRole: "delegado",
    q: `Fuera de obra: quieres presentar una propuesta de mejora preventiva por escrito para que quede trazabilidad. ¿A quién se la entregas?`,
    hint: "Participación con seguimiento.",
    answers: [
      { txt: "Al delegado/a de prevención.", grade: "green",
        why: "Canal idóneo para propuestas y seguimiento desde representación." },
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "amber",
        why: "Correcto, pero el delegado es un canal muy directo para propuestas de participación." },
      { txt: "Se la digo a Goku y que le meta un Kamehameha al riesgo.", grade: "red",
        why: "Goku gana combates, no gestiona propuestas preventivas.\nLa respuesta correcta en este caso es: {{GREEN}}" },
      { txt: "La dejo en un cajón y ya ‘saldrá sola’.", grade: "red",
        why: "Sin canal y seguimiento, no se gestiona." }
    ]
  },

  // 24) Fuera de obra: duda sobre procedimiento escrito (técnico)
  {
    id: 24,
    bestRole: "tecnico",
    q: `Fuera de obra: estás revisando documentación y no entiendes una instrucción preventiva (te genera dudas). ¿A quién la consultas?`,
    hint: "Consulta técnica/documental de prevención.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Es el canal técnico para resolver dudas de procedimiento/documentación." },
      { txt: "Al recurso preventivo (obra).", grade: "amber",
        why: "Correcto, pero el técnico PRL suele tener la interpretación y pauta más completa." },
      { txt: "A Spider‑Man: que lo solucione con telarañas.", grade: "red",
        why: "La telaraña no sustituye una pauta técnica real.\nLa respuesta correcta en este caso es: {{GREEN}}" },
      { txt: "Hago lo contrario y así ‘aprendo’ rápido.", grade: "red",
        why: "Aprender a base de errores en obra sale caro." }
    ]
  },

  // 25) Fuera de obra: solicitar acceso a formación/certificado (técnico)
  {
    id: 25,
    bestRole: "tecnico",
    q: `Fuera de obra: necesitas completar formación preventiva (o justificarla) y no sabes el canal/proceso. ¿A quién lo pides?`,
    hint: "Formación: proceso preventivo.",
    answers: [
      { txt: "Al técnico de PRL / Servicio de Prevención.", grade: "green",
        why: "Canal preventivo para formación y acreditaciones." },
      { txt: "Al mando directo.", grade: "amber",
        why: "Correcto, pero el canal preventivo para formación suele ser el técnico PRL." },
      { txt: "Me fabrico un certificado en Paint.", grade: "red",
        why: "Eso no es una formación real (ni un canal válido)." },
      { txt: "Me lo aprendo por osmosis mirando a los veteranos.", grade: "red",
        why: "Formación e instrucciones deben ser reales y verificables.\nLa respuesta correcta en este caso es: {{GREEN}}" }
    ]
  }
];

// --- Estado ---
let QUESTIONS = [];
let ORDER_SET = [];
let idx = 0;
let answered = false;

let gameMode = "quiz";      // quiz | tf | order
let playMode = "solo";      // solo | teams
let quickMode = false;      // solo Kahoot: sin repregunta
let teams = [];
let activeTeam = 0;

let score = 0;              // solo
let breakdown = [];

let followUpPending = false;
let lastConfig = null;
let lastPlanText = "";

// Helpers DOM
const $ = (id)=>document.getElementById(id);

// ---------- UI helpers (MP host) ----------
function setBtnRevealUI(revealed){
  const b = $("btnReveal");
  if(!b) return;
  b.disabled = !!revealed;
  b.classList.toggle("isActive", !!revealed);
  b.setAttribute("aria-pressed", revealed ? "true" : "false");
  if(revealed) b.blur();
}
function resetBtnRevealUI(){ setBtnRevealUI(false); }


// ---------- Fondo (tema) ----------
const BG_THEMES = {
  night:   { bg0:"#05070f", bg1:"#0b1220" },
  graphite:{ bg0:"#0b0d10", bg1:"#141821" },
  slate:   { bg0:"#050914", bg1:"#0b1630" },
  forest:  { bg0:"#06110c", bg1:"#0c1f16" },
  sand:    { bg0:"#1a140a", bg1:"#2a1d0c" },
};

function applyBgTheme(id, save=true){
  const t = BG_THEMES[id] || BG_THEMES.night;
  document.documentElement.style.setProperty("--bg0", t.bg0);
  document.documentElement.style.setProperty("--bg1", t.bg1);
  if (save){
    try{ lsSet("bgTheme", id); }catch(e){}
  }
}

function initBgTheme(){
  let saved = "night";
  try{ saved = lsGet("bgTheme") || "night"; }catch(e){}
  if ($("bgTheme")) $("bgTheme").value = BG_THEMES[saved] ? saved : "night";
  applyBgTheme($("bgTheme")?.value || "night", false);
}

const show = (id)=>$(id)?.classList.remove("hidden");
const hide = (id)=>$(id)?.classList.add("hidden");

function lsGet(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } }
function lsSet(k,v){ try{ localStorage.setItem(k,v); }catch(e){} }

function setState(txt){
  const pill = $("pillState");
  if (pill) pill.textContent = txt;
}


function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function shuffle(a){
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function deepCopyBank(bank){
  return bank.map(q => ({
    ...q,
    answers: Array.isArray(q.answers) ? q.answers.map((a,i)=>({ ...a, __aid: (a && a.__aid!=null) ? a.__aid : i })) : [],
    items: Array.isArray(q.items) ? q.items.slice() : q.items,
    correct: Array.isArray(q.correct) ? q.correct.slice() : q.correct,
    steps: Array.isArray(q.steps) ? q.steps.slice() : q.steps,
  }));
}

// ---------- Bancos extra ----------

const TF_BASE = [
  { id: 201, bestRole:"", q:"V/F: Si el mando directo no está localizable y es un tema menor, el recurso preventivo es una vía rápida.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Es una vía práctica para activar la corrección cuando el mando no está accesible."},
    {txt:"Falso", grade:"red",   why:"En temas menores y con mando no localizable, el recurso preventivo ayuda a actuar ya."}
  ]},
  { id: 202, bestRole:"", q:"V/F: El delegado/a de prevención sustituye al mando directo para gestionar incidencias urgentes en obra.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"red", why:"El delegado es canal de participación, pero no sustituye el canal operativo/urgente del mando."},
    {txt:"Falso", grade:"green",   why:"El delegado participa y propone, pero lo urgente va por vía operativa (mando / recurso / emergencia)."}
  ]},
  { id: 203, bestRole:"", q:"V/F: Si hay riesgo grave e inminente, se puede parar la actividad y avisar.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"La prioridad es evitar daño: asegurar, parar si procede y comunicar por el canal correcto."},
    {txt:"Falso", grade:"red",       why:"Ante riesgo grave, la seguridad manda: se actúa y se comunica."}
  ]},
  { id: 204, bestRole:"", q:"V/F: El CSS coordina interferencias entre empresas en obra.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"CSS = coordinación cuando hay concurrencia/contratas e interferencias."},
    {txt:"Falso", grade:"red",       why:"La coordinación de interferencias es parte del rol del CSS."}
  ]},
  { id: 205, bestRole:"", q:"V/F: El EPI es la primera medida que se aplica siempre, antes que las colectivas.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"red",   why:"La prioridad suele ser protección colectiva y medidas en origen antes que EPI."},
    {txt:"Falso", grade:"green",     why:"Primero se intenta controlar el riesgo en origen/colectivo; el EPI complementa."}
  ]},
  { id: 206, bestRole:"", q:"V/F: Una incidencia sin comunicar no existe a efectos de trazabilidad preventiva.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Si no se comunica/registre, no hay seguimiento ni corrección sistemática."},
    {txt:"Falso", grade:"red",       why:"Sin comunicación y registro, la organización no puede cerrar el riesgo."}
  ]},
  { id: 207, bestRole:"", q:"V/F: El recurso preventivo sólo actúa cuando hay accidente.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"red",   why:"Actúa también en prevención: observación, correcciones, recordatorios, trazabilidad."},
    {txt:"Falso", grade:"green",     why:"Su trabajo es preventivo (actuar antes), no sólo reaccionar a accidentes."}
  ]},
  { id: 208, bestRole:"", q:"V/F: Si detectas un riesgo, lo mejor es esperar al final del turno para decirlo.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"red",   why:"Se comunica cuanto antes para evitar que otros se expongan."},
    {txt:"Falso", grade:"green",     why:"La comunicación temprana permite corregir antes y evitar repetición."}
  ]},
  { id: 209, bestRole:"", q:"V/F: Si el riesgo afecta a varias contratas, además del mando, hay que pensar en coordinación.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Interferencias = coordinación (CSS/CAE) además de la vía operativa."},
    {txt:"Falso", grade:"red",       why:"Interferencias requieren coordinación; no es sólo un tema interno de una cuadrilla."}
  ]},
  { id: 210, bestRole:"", q:"V/F: En una situación grave, primero se atiende la emergencia y luego se escala internamente.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Primero vida/daño, luego comunicación interna y registro."},
    {txt:"Falso", grade:"red",       why:"La emergencia va primero: asegurar, pedir ayuda, y luego informar por vía interna."}
  ]},
  // Banco extra (para aleatoriedad)
  { id: 211, bestRole:"", q:"V/F: El técnico PRL es el canal para procedimientos, formación y consultas técnicas.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Procedimientos/consulta técnica = PRL/Servicio de prevención."},
    {txt:"Falso", grade:"red",       why:"Es precisamente uno de los canales típicos para consulta técnica de prevención."}
  ]},
  { id: 212, bestRole:"", q:"V/F: Si una corrección es repetida, conviene dejar constancia para seguimiento.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Reincidencias necesitan trazabilidad para cerrar el problema."},
    {txt:"Falso", grade:"red",       why:"Sin constancia no hay mejora sistemática ni seguimiento."}
  ]},
  { id: 213, bestRole:"", q:"V/F: Una señalización provisional puede ser una medida inmediata mientras se corrige la causa.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"Señalizar/aislar puede ser medida inmediata mientras se corrige."},
    {txt:"Falso", grade:"red",       why:"A veces es medida inmediata necesaria mientras se solventa la causa."}
  ]},
  { id: 214, bestRole:"", q:"V/F: Comunicar el riesgo no es “meterse en líos”: es parte del trabajo seguro.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"green", why:"La cultura preventiva se construye comunicando y corrigiendo."},
    {txt:"Falso", grade:"red",       why:"Precisamente comunicar es lo que evita líos (accidentes, paradas, sanciones)."}
  ]},
  { id: 215, bestRole:"", q:"V/F: Si hay dudas sobre un procedimiento, lo correcto es improvisar para no parar.", hint:"Marca Verdadero o Falso.", answers:[
    {txt:"Verdadero", grade:"red",   why:"Improvisar aumenta el riesgo. Se consulta y se actúa con método."},
    {txt:"Falso", grade:"green",     why:"Ante duda, se consulta (mando/PRL) y se asegura la tarea."}
  ]}
];

const ORDER_BASE = [
  { id: 301, q:"Ordena la actuación: Detectas un cable por el suelo en zona de paso.", hint:"Arrastra para ordenar de primero a último.", steps:[
      "Señalizar/aislar el paso para evitar tropiezos.",
      "Comunicar al mando (o recurso si el mando no está).",
      "Retirar/asegurar el cable (o pedir retirada) y dejar la zona limpia.",
      "Comprobar que el paso queda seguro y libre.",
      "Dejar constancia si es reincidente."
    ], why:"Primero se evita la exposición inmediata (señalizar/aislar), luego se comunica y se corrige la causa, y por último se deja trazabilidad si se repite." },
  { id: 302, q:"Ordena la actuación: Ves una protección colectiva deteriorada (barandilla floja).", hint:"Arrastra para ordenar de primero a último.", steps:[
      "Detener el acceso a la zona (aislar).",
      "Avisar al mando directo (o recurso si no está localizable).",
      "Reparar o sustituir la protección colectiva antes de reanudar.",
      "Verificar la estabilidad/ajuste tras la reparación.",
      "Registrar/seguir si es un punto crítico."
    ], why:"Si la protección colectiva falla, lo inmediato es evitar el acceso. Después se activa corrección por vía operativa y se verifica antes de reanudar." },
  { id: 303, q:"Ordena la actuación: Hay una situación con riesgo grave (posible caída/atrapamiento) y alguien podría lesionarse.", hint:"Arrastra para ordenar de primero a último.", steps:[
      "Parar/asegurar la situación para eliminar la exposición inmediata.",
      "Pedir ayuda/emergencia si procede (112 / primer interviniente).",
      "Avisar al mando directo y/o recurso preventivo.",
      "Atender y proteger a los implicados sin generar más riesgo.",
      "Registrar y analizar para que no se repita."
    ], why:"En grave: primero se corta la exposición (parar/asegurar). Si hay lesión, emergencia. Luego comunicación interna y cierre con registro/análisis." },
  { id: 304, q:"Ordena la actuación: Reincidencia de orden y limpieza en el mismo punto cada día.", hint:"Arrastra para ordenar de primero a último.", steps:[
      "Comunicar al mando (o recurso si no está) con ubicación exacta.",
      "Corregir el punto (retirada/orden/itinerario).",
      "Identificar causa (falta de contenedor, acopio mal planificado, etc.).",
      "Implementar medida organizativa (responsable, horarios, checklist).",
      "Dejar constancia y revisar al día siguiente."
    ], why:"Reincidencia = no basta con limpiar: hay que encontrar causa, meter medida organizativa y revisar." },
  { id: 305, q:"Ordena la actuación: Dudas sobre uso correcto de un equipo/herramienta.", hint:"Arrastra para ordenar de primero a último.", steps:[
      "Detener la tarea si hay duda de seguridad.",
      "Consultar al mando / recurso preventivo.",
      "Consultar al técnico PRL si es procedimiento/formación.",
      "Aplicar el método correcto (procedimiento + protecciones).",
      "Registrar la lección (briefing/toolbox) para el equipo."
    ], why:"La duda se gestiona parando y consultando. Si es técnico/procedimental, PRL. Luego se aplica y se transfiere al equipo." }
];


const SEMA_BASE = [
  // Semáforo: “¿Qué haces primero?”
  { id: 401, bestRole:"mando", q:`Ves un hueco en forjado sin protección en una zona de paso. ¿Qué haces primero?`, hint:"Acción inmediata (5 s).", answers:[
    {txt:"PARO la tarea y AISLO/SEÑALIZO la zona.", grade:"green", why:"Riesgo de caída grave: primero se elimina la exposición (parar/aislar) y luego se comunica."},
    {txt:"AVISO al mando y ya verán.", grade:"amber", why:"Avisar está bien, pero antes hay que evitar que alguien caiga (aislar/parar)."},
    {txt:"SIGO, que no es mi trabajo.", grade:"red", why:"Ignorar el riesgo mantiene la exposición. En obra, la prioridad es evitar daño."},
    {txt:"SEÑALIZO con la mano desde lejos.", grade:"red", why:"Sin aislamiento real (baliza/cinta/barandilla provisional) sigues dejando el paso expuesto."}
  ]},
  { id: 402, bestRole:"mando", q:`Ves una escalera de mano apoyada sin sujeción y alguien va a subir. ¿Qué haces primero?`, hint:"Acción inmediata (5 s).", answers:[
    {txt:"PARO y estabilizo/aseguro la escalera antes de usarla.", grade:"green", why:"Primero se evita la caída: parar y asegurar (ángulo, apoyo, sujeción/ayuda) antes de continuar."},
    {txt:"AVISO al recurso preventivo para que lo vea.", grade:"amber", why:"Bien avisar, pero la primera acción es evitar la exposición (parar/asegurar)."},
    {txt:"SIGO porque “solo es un momento”.", grade:"red", why:"Los “dos minutos” son el clásico desencadenante. Si no está segura, se para."},
    {txt:"Hago una foto y la mando al grupo.", grade:"red", why:"La evidencia puede venir después. Lo primero es el control inmediato del riesgo."}
  ]},
  { id: 403, bestRole:"recurso", q:`Hay materiales tirados en un pasillo y el mando está reunido/no localizable. ¿Qué haces primero?`, hint:"Tema menor pero con riesgo de tropiezo.", answers:[
    {txt:"AISLO el paso (si procede) y aviso al recurso/mando para retirar y ordenar.", grade:"green", why:"Control inmediato (evitar tropiezos) y aviso para corrección y seguimiento."},
    {txt:"AVISO y espero a que lo retiren.", grade:"amber", why:"Avisar ayuda, pero si puedes, reduce el riesgo ya (señalizar/aislar el paso)."},
    {txt:"SIGO con cuidado.", grade:"red", why:"“Con cuidado” no es control del riesgo. Alguien puede no verlo."},
    {txt:"Lo salto y ya.", grade:"red", why:"No elimina el riesgo para los demás ni deja constancia."}
  ]},
  { id: 404, bestRole:"mando", q:`Ves un izado de cargas sin balizar y gente pasando por debajo. ¿Qué haces primero?`, hint:"Riesgo grave.", answers:[
    {txt:"PARO el paso bajo la carga y AISLO la zona de izado.", grade:"green", why:"Riesgo grave e inminente: nadie debe pasar bajo cargas. Primero se aísla y se detiene."},
    {txt:"AVISO al operador desde lejos.", grade:"amber", why:"Avisar está bien, pero hay que cortar el paso ya (aislar/ordenar parada)."},
    {txt:"SIGO porque voy rápido.", grade:"red", why:"Pasar bajo una carga suspendida es un riesgo crítico."},
    {txt:"SEÑALIZO con un papelito.", grade:"red", why:"Se necesita balizamiento real y control del paso, no una señal improvisada sin eficacia."}
  ]},
  { id: 405, bestRole:"mando", q:`Ves un cable eléctrico pelado en zona húmeda. ¿Qué haces primero?`, hint:"Electricidad.", answers:[
    {txt:"PARO y AISLO el área; no toco el cable.", grade:"green", why:"Primero evitar contacto: parar, aislar y avisar para cortar tensión/reparar. No manipular."},
    {txt:"AVISO al electricista y sigo.", grade:"amber", why:"Avisar es correcto, pero antes evita que alguien toque/pise el cable (aislar/parar)."},
    {txt:"Lo enrollo con cinta y listo.", grade:"red", why:"No es reparación segura: puede agravar el riesgo eléctrico."},
    {txt:"SIGO porque llevo botas.", grade:"red", why:"El EPI no sustituye el control del riesgo eléctrico ni garantiza seguridad."}
  ]},
  { id: 406, bestRole:"mando", q:`En una zona de corte (radial) no hay pantalla ni delimitación y pasan personas cerca. ¿Qué haces primero?`, hint:"Proyecciones/atrapamientos.", answers:[
    {txt:"AISLO/SEÑALIZO y PARO el trabajo hasta delimitar.", grade:"green", why:"Primero evitar exposición de terceros: delimitar, ordenar y reanudar con control."},
    {txt:"AVISO al operario para que tenga cuidado.", grade:"amber", why:"Bien avisar, pero hay que establecer control (delimitación) para terceros."},
    {txt:"SIGO, que cada uno mire.", grade:"red", why:"La prevención no se basa en “mirar”, se basa en controlar el riesgo."},
    {txt:"Me quedo mirando a ver si salta una chispa.", grade:"red", why:"No es una medida preventiva ni reduce el riesgo."}
  ]},
  { id: 407, bestRole:"recurso", q:`Ves señalización caída/evacuación tapada por material. No es emergencia, pero confunde el paso. ¿Qué haces primero?`, hint:"Orden y señalización.", answers:[
    {txt:"Retiro/ordeno si es seguro y aviso para dejar constancia.", grade:"green", why:"Se recupera el itinerario seguro y se comunica para que no se repita."},
    {txt:"Aviso y no toco nada.", grade:"amber", why:"Avisar está bien, pero si puedes retirar sin riesgo, reduces exposición ya."},
    {txt:"Sigo, total se ve igual.", grade:"red", why:"En una evacuación, cada segundo cuenta. Señalización y paso deben estar libres."},
    {txt:"Lo apunto para mañana.", grade:"red", why:"La corrección debe ser inmediata si afecta a itinerarios o señalización."}
  ]},
  { id: 408, bestRole:"mando", q:`Ves barandilla floja en un borde. ¿Qué haces primero?`, hint:"Alturas.", answers:[
    {txt:"PARO el uso del borde y AISLO la zona hasta reparar.", grade:"green", why:"Protección colectiva defectuosa = riesgo grave. Primero se impide el acceso."},
    {txt:"Aviso al mando y sigo trabajando cerca.", grade:"amber", why:"Avisar sí, pero no te expongas: impide el acceso/uso hasta reparar."},
    {txt:"Aprieto yo sin herramientas.", grade:"red", why:"Puede fallar. Debe repararse correctamente y verificar estabilidad."},
    {txt:"Hago como que no lo he visto.", grade:"red", why:"Ignorar no reduce el riesgo. La exposición continúa."}
  ]},
  { id: 409, bestRole:"mando", q:`Alguien empieza a trabajar sin EPI ocular en una zona de proyecciones. ¿Qué haces primero?`, hint:"EPI / control inmediato.", answers:[
    {txt:"PARO y exijo EPI adecuado antes de continuar.", grade:"green", why:"Si el riesgo es inmediato (proyecciones), primero se detiene y se equipa."},
    {txt:"Aviso al técnico PRL para que lo apunte.", grade:"amber", why:"Puede registrarse después. Lo inmediato es evitar la lesión."},
    {txt:"Sigo, a mí no me afecta.", grade:"red", why:"En obra, el riesgo es del equipo y la intervención evita daños."},
    {txt:"Le grito desde lejos “ponte gafas” y ya.", grade:"red", why:"Si no se asegura la corrección, la exposición sigue. Mejor parar y verificar."}
  ]},
  { id: 410, bestRole:"mando", q:`Ves polvo intenso al cortar (posible sílice) sin extracción ni control. ¿Qué haces primero?`, hint:"Higiene industrial.", answers:[
    {txt:"PARO y AVISO para aplicar control (humectación/extracción/mascarilla adecuada).", grade:"green", why:"Primero frenar exposición y activar medidas. Luego se define control y EPI adecuado."},
    {txt:"Aviso y que sigan “rápido”.", grade:"amber", why:"Avisar ayuda, pero hay que parar o reducir exposición inmediatamente."},
    {txt:"Sigo y me tapo la cara con la camiseta.", grade:"red", why:"No es un control válido ni EPI. Riesgo inhalación."},
    {txt:"Hago un chiste sobre “niebla” y sigo.", grade:"red", why:"No aporta control preventivo."}
  ]},
  { id: 411, bestRole:"mando", q:`Ves un derrame de aceite en zona de paso. ¿Qué haces primero?`, hint:"Caídas al mismo nivel.", answers:[
    {txt:"AISLO la zona y aviso para limpiar con absorbente.", grade:"green", why:"Primero evitar resbalones: aislar y gestionar limpieza segura."},
    {txt:"Aviso a alguien y me voy.", grade:"amber", why:"Avisar sí, pero si no se aísla, alguien puede caer antes."},
    {txt:"Paso por encima y ya.", grade:"red", why:"No elimina riesgo para el resto."},
    {txt:"Lo limpio con agua a presión.", grade:"red", why:"Puede extender el derrame; se usa absorbente/procedimiento adecuado."}
  ]}
];

const CHECK_BASE = [
  { id: 501, bestRole:"mando", q:"Checklist: Trabajo con radial en obra. Elige los 3 imprescindibles antes de empezar.", hint:"Elige 3.", items:[
      "Gafas/pantalla facial y protección ocular.",
      "Delimitar la zona para terceros (chispas/proyecciones).",
      "Disco adecuado y en buen estado (sin fisuras).",
      "Guantes de lana gruesa para todo.",
      "Trabajar sin protector para ver mejor.",
      "Cortar mirando hacia la gente para avisar."
    ],
    correct:[0,1,2],
    whyGreen:"Controlas proyecciones (EPI + zona) y evitas fallo del disco.",
    whyAmber:"Vas bien, pero falta un imprescindible para evitar lesión grave.",
    whyRed:"Faltan controles básicos: riesgo de proyecciones, corte y fallo del disco."
  },
  { id: 502, bestRole:"mando", q:"Checklist: Uso de escalera de mano. Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Ángulo correcto y apoyo estable (sin deslizamiento).",
      "Sujeción/estabilización (o ayuda) y 3 puntos de apoyo.",
      "Zona libre y señalizada si hay paso de terceros.",
      "Subir con carga pesada en ambas manos.",
      "Apoyarla sobre tubo redondo sin sujeción.",
      "Subir al último peldaño para llegar."
    ],
    correct:[0,1,2],
    whyGreen:"Aseguras estabilidad y evitas caídas propias y de terceros.",
    whyAmber:"Casi: falta un control clave para estabilidad/entorno.",
    whyRed:"Con esas elecciones sigues exponiéndote a caída y vuelco."
  },
  { id: 503, bestRole:"mando", q:"Checklist: Izado de cargas con grúa. Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Balizar/aislar la zona y prohibir paso bajo la carga.",
      "Eslingas/útiles adecuados y revisados visualmente.",
      "Señalista/comunicación clara con el operador.",
      "Pasar por debajo “rápido”.",
      "Izar sin plan porque “ya lo hemos hecho”.",
      "Atar la carga con cuerda fina de embalaje."
    ],
    correct:[0,1,2],
    whyGreen:"Evitas el riesgo crítico (paso bajo carga) y aseguras útiles y comunicación.",
    whyAmber:"Bien, pero falta un imprescindible para controlar el izado.",
    whyRed:"Faltan controles clave: riesgo de golpe/caída de carga."
  },
  { id: 504, bestRole:"mando", q:"Checklist: Electricidad provisional en obra. Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Cuadro protegido y con diferenciales/automatismos adecuados.",
      "Cables en buen estado (sin peladuras) y protegidos del paso.",
      "Cortar tensión/aislar antes de manipular.",
      "Empalmar con cinta aislante como solución final.",
      "Usar enchufes sin toma de tierra “porque funciona”.",
      "Tirar de un cable para desenchufar."
    ],
    correct:[0,1,2],
    whyGreen:"Controlas el riesgo eléctrico: protección, integridad y desconexión.",
    whyAmber:"Falta un imprescindible (protección o desconexión) para evitar electrocución.",
    whyRed:"Con esas opciones se mantiene riesgo eléctrico serio."
  },
  { id: 505, bestRole:"mando", q:"Checklist: Trabajos en altura (borde/forjado). Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Protección colectiva (barandilla/red) instalada y firme.",
      "Acceso seguro y zona balizada si hay huecos/bordes.",
      "Si no hay colectiva viable: sistema anticaídas adecuado (anclaje + arnés) y uso correcto.",
      "Trabajar sentado en el borde para “ver mejor”.",
      "Usar arnés sin anclarse para cumplir.",
      "Saltar el hueco porque es pequeño."
    ],
    correct:[0,1,2],
    whyGreen:"Primero colectiva; si no, anticaídas real. Y control del entorno.",
    whyAmber:"Casi: falta un imprescindible (colectiva/anclaje/balizamiento).",
    whyRed:"Faltan controles críticos: caída de altura."
  },
  { id: 506, bestRole:"mando", q:"Checklist: Excavación zanja. Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Entibación/taludado según profundidad y terreno.",
      "Acceso seguro (escalera) y control de entrada/salida.",
      "Señalización/balizamiento perimetral y acopios alejados del borde.",
      "Meterse “un momento” sin entibar.",
      "Dejar la retro al borde para ahorrar viaje.",
      "Bajar saltando dentro."
    ],
    correct:[0,1,2],
    whyGreen:"Evitas sepultamiento/caída: estabilidad, acceso y perímetro.",
    whyAmber:"Bien, pero falta un control clave (estabilidad/perímetro/acceso).",
    whyRed:"Sin estabilidad y control, el riesgo de sepultamiento es alto."
  },
  { id: 507, bestRole:"mando", q:"Checklist: Corte con polvo (posible sílice). Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Control de polvo (humectación/extracción local).",
      "Mascarilla adecuada al riesgo (no “cualquiera”).",
      "Planificar para reducir exposición (tiempo/zonas/ventilación).",
      "Taparse con la camiseta.",
      "Soplar con aire comprimido para limpiar.",
      "Trabajar en interior sin ventilación."
    ],
    correct:[0,1,2],
    whyGreen:"Reducir exposición primero (control de polvo) y luego EPI y organización.",
    whyAmber:"Casi: falta un imprescindible para controlar la inhalación.",
    whyRed:"Se mantiene exposición alta a polvo: riesgo respiratorio."
  },
  { id: 508, bestRole:"recurso", q:"Checklist: Orden y limpieza en pasillos. Elige los 3 imprescindibles.", hint:"Elige 3.", items:[
      "Mantener itinerarios libres y señalizados.",
      "Retirar/ordenar materiales tras uso (no acumular).",
      "Gestionar residuos/derrames con método (absorber/limpiar).",
      "Dejar cables sueltos porque “luego vuelvo”.",
      "Apilar material tapando extintores/salidas.",
      "Iluminar menos para que no se vea el desorden."
    ],
    correct:[0,1,2],
    whyGreen:"Reduce tropiezos/evacuación y evita incidentes repetidos.",
    whyAmber:"Falta un básico de control de itinerarios/derrames.",
    whyRed:"Esas opciones aumentan tropiezos y bloquean emergencias."
  }
];

const MYTH_BASE = [
  { id: 601, bestRole:"", q:"Frase: “Son dos minutos, no hace falta asegurar.”", hint:"Mito / Verdad / Depende.", answers:[
    {txt:"Mito", grade:"green", why:"Los accidentes suelen ocurrir en tareas cortas y repetidas. Si no está seguro, se para/asegura."},
    {txt:"Verdad", grade:"red",  why:"La duración no reduce el riesgo real."},
    {txt:"Depende", grade:"red",  why:"En seguridad, si hay exposición, se controla. No depende del tiempo."}
  ]},
  { id: 602, bestRole:"", q:"Frase: “Con EPI ya puedo trabajar aunque falte la barandilla.”", hint:"Mito / Verdad / Depende.", answers:[
    {txt:"Mito", grade:"green", why:"Primero protección colectiva. El EPI no sustituye barandillas/redes y no elimina el riesgo."},
    {txt:"Verdad", grade:"red",  why:"EPI no compensa ausencia de protecciones colectivas en altura."},
    {txt:"Depende", grade:"red",  why:"Solo en casos muy concretos y con sistemas anticaídas bien implantados, pero nunca como excusa."}
  ]},
  { id: 603, bestRole:"", q:"Frase: “Si el mando no está, no se puede hacer nada.”", hint:"Mito / Verdad / Depende.", answers:[
    {txt:"Mito", grade:"green", why:"Siempre puedes controlar el riesgo inmediato (parar/aislar) y avisar al recurso preventivo o mando."},
    {txt:"Verdad", grade:"red",  why:"Sí se puede actuar: control inmediato y comunicación."},
    {txt:"Depende", grade:"red",  why:"La actuación preventiva no depende: el control inmediato se hace siempre."}
  ]},
  { id: 604, bestRole:"", q:"Frase: “Parar por riesgo te puede costar una bronca, mejor seguir.”", hint:"Mito / Verdad / Depende.", answers:[
    {txt:"Mito", grade:"green", why:"Ante riesgo grave e inminente se prioriza seguridad: parar, aislar y comunicar."},
    {txt:"Verdad", grade:"red",  why:"No: la seguridad es prioritaria y parar evita daño."},
    {txt:"Depende", grade:"red",  why:"No depende: se actúa preventivamente."}
  ]},
  { id: 605, bestRole:"", q:"Frase: “Si lo he hecho muchas veces, no pasa nada.”", hint:"Mito / Verdad / Depende.", answers:[
    {txt:"Mito", grade:"green", why:"La experiencia reduce incertidumbre, pero no elimina riesgos. Se mantienen controles."},
    {txt:"Verdad", grade:"red",  why:"La repetición no elimina el riesgo."},
    {txt:"Depende", grade:"red",  why:"Depende no: el control debe mantenerse siempre."}
  ]},
  { id: 606, bestRole:"", q:"Frase: “El delegado de prevención es para propuestas, no para avisos urgentes.”", hint:"Mito / Verdad / Depende.", answers:[
    {txt:"Verdad", grade:"green", why:"Lo urgente va por vía operativa (mando/recurso/emergencia). El delegado canaliza participación y propuestas."},
    {txt:"Mito", grade:"red",  why:"No sustituye al mando en urgencias."},
    {txt:"Depende", grade:"amber",  why:"En una urgencia puedes informar a todos, pero el canal operativo sigue siendo mando/recurso/112."}
  ]}
];

const SAY_BASE = [
  { id: 701, bestRole:"mando", q:"Aviso: has visto un hueco sin protección. ¿Qué mensaje es mejor para el mando?", hint:"Elige el aviso más accionable.", answers:[
    {txt:"“Planta 2, ala norte: hueco sin barandilla en paso. He parado y balizado. Necesito que vengas a corregir y dejar constancia.”", grade:"green", why:"Incluye ubicación + riesgo + control provisional + petición clara."},
    {txt:"“Hay un hueco por ahí, pásate cuando puedas.”", grade:"amber", why:"Falta ubicación exacta y qué control has aplicado."},
    {txt:"“Esto es un desastre, siempre igual…”", grade:"red", why:"No aporta información accionable ni control inmediato."},
    {txt:"“Ven YA”", grade:"red", why:"Sin ubicación ni riesgo, no es accionable."}
  ]},
  { id: 702, bestRole:"recurso", q:"Aviso: orden y limpieza (material en pasillo) y el mando no está localizable. ¿Qué mensaje es mejor al recurso preventivo?", hint:"Elige el aviso más accionable.", answers:[
    {txt:"“Pasillo entre acopios A y B: material en el suelo (tropiezo). He señalizado el paso. Necesito retirada y registro para evitar reincidencia.”", grade:"green", why:"Ubicación + riesgo + medida provisional + seguimiento: perfecto para recurso."},
    {txt:"“Hay cosas por el suelo, que lo vea PRL.”", grade:"amber", why:"Bien, pero falta ubicación exacta y qué medida provisional has tomado."},
    {txt:"“No es mi problema.”", grade:"red", why:"No ayuda a controlar el riesgo ni a prevenir repetición."},
    {txt:"“Luego te cuento.”", grade:"red", why:"Demasiado vago y tarde."}
  ]},
  { id: 703, bestRole:"mando", q:"Aviso: izado sin balizar con gente pasando. ¿Qué mensaje es mejor?", hint:"Elige el aviso más accionable.", answers:[
    {txt:"“Zona carga/descarga: izado sin balizar y gente pasando bajo carga. He parado el paso y balizado. Necesito señalista y control del perímetro.”", grade:"green", why:"Describe riesgo crítico y control inmediato. Muy accionable."},
    {txt:"“Están izando mal.”", grade:"amber", why:"Falta ubicación y qué control has aplicado."},
    {txt:"“Menuda liada llevan.”", grade:"red", why:"No aporta datos ni petición."},
    {txt:"“Sube que hay lío.”", grade:"red", why:"No es claro ni accionable."}
  ]},
  { id: 704, bestRole:"tecnico", q:"Aviso: te piden un EPI específico (p. ej. mascarilla por polvo) y no hay claro qué usar. ¿Qué mensaje es mejor a PRL/SP?", hint:"Elige el aviso más accionable.", answers:[
    {txt:"“Tarea: corte con polvo (posible sílice). Ubicación: nave 3. Necesitamos criterio de control (humectación/extracción) y EPI respiratorio adecuado + formación de uso.”", grade:"green", why:"Da contexto técnico y pide criterio preventivo (ingeniería + EPI)."},
    {txt:"“Mándame una mascarilla buena.”", grade:"amber", why:"No define tarea ni riesgo; difícil acertar EPI/control."},
    {txt:"“Nos ahogamos aquí.”", grade:"red", why:"No aporta tarea, ubicación ni petición concreta."},
    {txt:"“Me compras lo más barato.”", grade:"red", why:"Criterio económico no puede sustituir criterio preventivo."}
  ]},
  { id: 705, bestRole:"css", q:"Aviso: interferencias entre contratas en la misma zona. ¿Qué mensaje es mejor al CSS?", hint:"Elige el aviso más accionable.", answers:[
    {txt:"“Zona X: contrata A y B coinciden y se interfieren (riesgo atropello/atrapamiento). He parado el cruce y señalizado. Necesito coordinación de planificación e itinerarios.”", grade:"green", why:"Ubicación + interferencia + control provisional + petición de coordinación."},
    {txt:"“Se molestan dos contratas.”", grade:"amber", why:"Falta riesgo concreto y qué control provisional has aplicado."},
    {txt:"“Que se apañen.”", grade:"red", why:"No coordina ni reduce el riesgo."},
    {txt:"“Haz algo.”", grade:"red", why:"Sin datos, no es accionable."}
  ]}
];


// ---------- Checklist express ----------
let checkSelected = [];

function startChecklist(bank, takeN){
  QUESTIONS = bank.map(q=>({
    id:q.id,
    bestRole:q.bestRole || "",
    q:q.q, hint:q.hint || "",
    items: q.items.slice(),
    correct: q.correct.slice(),
    whyGreen: q.whyGreen || "",
    whyAmber: q.whyAmber || "",
    whyRed: q.whyRed || ""
  }));
  // i18n (traduce items y explicaciones)
  QUESTIONS.forEach(q=>applyQTranslation("check", q));
  shuffle(QUESTIONS);
  QUESTIONS = QUESTIONS.slice(0, Math.min(takeN, QUESTIONS.length));

  hide("start"); hide("result"); show("quiz");
  hide("answers"); hide("orderArea"); show("checkArea");
  hide("feedback"); hide("followUp"); hide("btnNext");
  if ($("btnNext")) $("btnNext").disabled = false;

  idx = 0;
  answered = false;
  followUpPending = false;
  checkSelected = [];

  setState(t("state.playing","En curso"));
  renderChecklistRound();
}

function renderChecklistRound(){
  answered = false;
  followUpPending = false;
  checkSelected = [];

  clearTimer();

  hide("feedback");
  hide("followUp");
  hide("btnNext");

  updateProgressUI();
  updateScoreUI();

  const q = QUESTIONS[idx];
  $("qText").textContent = q.q;
  $("qHint").textContent = q.hint || "";

  if ($("qTimer")) hide("qTimer");

  const instr = $("checkInstr");
  const list = $("checkList");
  if (!list || !instr) return;

  instr.textContent = fmt(t("check.instr","Elige los 3 imprescindibles antes de empezar. ({N}/3)"), {N:0});
  list.innerHTML = "";

  q.items.forEach((t, i)=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "checkItem";
    b.textContent = t;
    b.addEventListener("click", ()=>{
      if (answered) return;
      toggleCheck(i, b);
    });
    list.appendChild(b);
  });

  const btn = $("btnCheckChecklist");
  if (btn){
    btn.disabled = true;
    btn.onclick = ()=>evaluateChecklist();
  }
}

function toggleCheck(i, btnEl){
  const pos = checkSelected.indexOf(i);
  if (pos !== -1){
    checkSelected.splice(pos, 1);
    btnEl.classList.remove("on");
  } else {
    if (checkSelected.length >= 3) return;
    checkSelected.push(i);
    btnEl.classList.add("on");
  }
  const instr = $("checkInstr");
  if (instr) instr.textContent = `Elige los 3 imprescindibles antes de empezar. (${checkSelected.length}/3)`;

  const btn = $("btnCheckChecklist");
  if (btn) btn.disabled = (checkSelected.length !== 3);
}

function evaluateChecklist(){
  if (answered) return;
  if (checkSelected.length !== 3) return;

  answered = true;

  const q = QUESTIONS[idx];
  const correctSet = new Set(q.correct);
  const picksTxt = checkSelected.map(i=>q.items[i]).join(" · ");

  let hits = 0;
  checkSelected.forEach(i=>{ if (correctSet.has(i)) hits++; });

  let grade = "red";
  if (hits === 3) grade = "green";
  else if (hits === 2) grade = "amber";

  const pts = gradePoints(grade);
  addPoints(pts);

  // feedback
  const titleEl = $("fbTitle");
  const bodyEl  = $("fbBody");
  if (grade === "green"){
  title = t("fb.title.green","✅ Perfecto");
  body  = "✅ " + (whyResolved || "");
} else if (grade === "amber"){
  title = t("fb.title.amber","🟠 Correcto… pero se puede hacer mejor");
  if (whyResolved){
    body = "🟠 " + whyResolved;
  } else {
    body = fmt(t("fb.body.amber","🟠 Bien, pero hay un canal más adecuado aquí.\n\n✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt});
  }
  if (!usesGreenPlaceholder(why)){
    body += "\n\n" + fmt(t("fb.mostCorrect","✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt});
  }
} else {
  title = t("fb.title.red","🔴 Incorrecto");
  if (whyResolved){
    body = "🔴 " + whyResolved;
  } else {
    body = fmt(t("fb.body.red","🔴 No es la mejor opción para seguridad.\n\n✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt});
  }
  if (!usesGreenPlaceholder(why)){
    body += "\n\n" + fmt(t("fb.mostCorrect","✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt});
  }
}

  show("feedback");
  show("btnNext");

  breakdown.push({
    n: idx+1,
    q: q.q,
    pick: picksTxt || "—",
    grade,
    pts,
    team: (playMode==="teams") ? (teams[activeTeam]?.name || "") : ""
  });

  updateScoreUI();
  const pct2 = Math.round(((idx+1) / Math.max(1, roundTotal())) * 100);
  if ($("bar")) $("bar").style.width = pct2 + "%";

  if ($("btnNext")) $("btnNext").disabled = false;
}

// ---------- Temporizador (Semáforo) ----------
let timerHandle = null;
let timerLeft = 0;

function clearTimer(){
  if (timerHandle){
    clearInterval(timerHandle);
    timerHandle = null;
  }
  timerLeft = 0;
  if ($("qTimer")) hide("qTimer");
}

function startTimer(seconds){
  clearTimer();
  timerLeft = seconds;
  const pill = $("qTimer");
  if (pill){
    pill.textContent = "⏱ " + timerLeft;
    show("qTimer");
  }
  timerHandle = setInterval(()=>{
    timerLeft--;
    if (pill) pill.textContent = "⏱ " + Math.max(0, timerLeft);
    if (timerLeft <= 0){
      clearTimer();
      // tiempo agotado → cuenta como roja
      selectAnswer(-1, "sema", true);
    }
  }, 1000);
}

// ---------- Configuración / equipos ----------
function buildTeamsFromUI(){
  teams = [];
  activeTeam = 0;
  if (playMode !== "teams") return;

  const n = Math.min(4, Math.max(2, parseInt($("teamCount")?.value || "2", 10)));
  const nameInputs = Array.from(document.querySelectorAll("#teamNames input"));

  for (let i=0;i<n;i++){
    const raw = nameInputs[i]?.value?.trim();
    const name = raw ? raw : ("Equipo " + (i+1));
    teams.push({ name, score: 0 });
  }
}

function resetScores(){
  score = 0;
  teams.forEach(t => t.score = 0);
}

function addPoints(pts){
  if (playMode === "teams"){
    teams[activeTeam].score += pts;
  } else {
    score += pts;
  }
}

function totalScore(){
  return (playMode === "teams")
    ? teams.reduce((s,t)=>s+t.score,0)
    : score;
}

function maxScore(){
  return roundTotal() * 2;
}

function roundTotal(){
  if (gameMode === "order") return ORDER_SET.length;
  return QUESTIONS.length;
}

function rotateTeam(){
  if (playMode === "teams"){
    activeTeam = (activeTeam + 1) % teams.length;
  }
}

function renderTeamBar(){
  const bar = $("teamBar");
  if (!bar) return;

  if (playMode !== "teams"){
    bar.innerHTML = "";
    hide("teamBar");
    return;
  }

  bar.innerHTML = teams.map((t, i)=>{
    const cls = i === activeTeam ? "teamChip active" : "teamChip";
    return `<span class="${cls}"><b>${escapeHtml(t.name)}</b> · ${t.score}</span>`;
  }).join("");

  show("teamBar");
}

function updateScoreUI(){
  const el = $("qScore");
  if (!el) return;

  if (playMode === "teams"){
    el.textContent = fmt(
      t("quiz.teamScore","Turno: {TEAM} · Total: {TOTAL}"),
      { TEAM: (teams[activeTeam]?.name || t("team.default","Equipo")), TOTAL: totalScore() }
    );
  } else {
    el.textContent = fmt(
      t("quiz.soloScore","Puntos: {SCORE}"),
      { SCORE: score }
    );
  }
  renderTeamBar();
}

function updateProgressUI(){
  const total = roundTotal();
  const pct = Math.round((idx / Math.max(1, total)) * 100);
  if ($("bar")) $("bar").style.width = pct + "%";
  if ($("qCounter")) $("qCounter").textContent = fmt(t("quiz.progress","Ronda {CUR}/{TOTAL}"), {CUR: idx+1, TOTAL: total});
}

// ---------- Inicio / UI ----------
function updateStartUI(){
  const pm = $("playMode")?.value || "solo";
  const gm = $("gameMode")?.value || "quiz";

  // participación
  if (pm === "teams"){
    show("teamCountWrap");
    show("teamNames");
  } else {
    hide("teamCountWrap");
    hide("teamNames");
  }

  // nombres equipos
  if (pm === "teams"){
    const n = Math.min(4, Math.max(2, parseInt($("teamCount")?.value || "2", 10)));
    const wrap = $("teamNames");
    if (wrap){
      wrap.innerHTML = "";
      for (let i=0;i<n;i++){
        const lab = document.createElement("label");
        lab.className = "field";
        lab.innerHTML = `<span class="lbl">${escapeHtml(fmt(t("team.nameLabel","Nombre equipo {N}"), {N:i+1}))}</span><input class="inp" type="text" placeholder="${escapeHtml(fmt(t("team.namePh","Equipo {N}"), {N:i+1}))}">`;
        wrap.appendChild(lab);
      }
    }
  }

  // ritmo Kahoot (solo quiz)
  if (gm === "quiz"){
    show("quizPaceWrap");
  } else {
    hide("quizPaceWrap");
  }

    // ayuda modo
  const help = $("modeHelp");
  if (help){
    const fallback =
      (gm === "quiz")  ? "Preguntas rápidas: elige a quién avisar y por qué. (10 rondas)" :
      (gm === "tf")    ? "Verdadero/Falso: 10 frases rápidas. Puntuación: acierto = 2 · fallo = 0." :
      (gm === "order") ? "Ordena la actuación: 3 rondas. Ordena de primero a último (control inmediato → comunicar → corregir)." :
      (gm === "sema")  ? "Semáforo (5 s): decide la primera acción (parar / aislar / avisar). Si dudas: para y avisa." :
      (gm === "check") ? "Checklist express: elige los 3 imprescindibles antes de empezar. (8 rondas)" :
      (gm === "myth")  ? "Frase trampa: mito / verdad / depende. (10 rondas)" :
      (gm === "say")   ? "¿Qué le digo al mando?: elige el aviso más accionable (ubicación + riesgo + control provisional). (10 rondas)" :
      "—";

    help.textContent = t(`help.${gm}`, fallback);
  }
}

function resetAll(){
  hide("quiz"); hide("result"); show("start");
  setState(t("state.ready","Listo"));
  // limpiar UI quiz
  hide("feedback"); hide("btnNext"); hide("followUp");
  if ($("answers")) $("answers").innerHTML = "";
  if ($("orderList")) $("orderList").innerHTML = "";
  hide("orderArea");
  hide("checkArea");
  show("answers");
  clearTimer();
  hide("stopWorkOverlay");
  // reset
  idx = 0;
  answered = false;
  breakdown = [];
  followUpPending = false;
  lastPlanText = "";
}

function startGame(){
  // lee UI
  gameMode = $("gameMode")?.value || "quiz";
  playMode = $("playMode")?.value || "solo";

  // ritmo (solo Kahoot)
  quickMode = (gameMode === "quiz") && (($("quizPace")?.value || "normal") === "fast");

  if (playMode === "teams"){
    buildTeamsFromUI();
  } else {
    teams = [];
    activeTeam = 0;
  }

  resetScores();
  breakdown = [];
  idx = 0;
  answered = false;
  followUpPending = false;
  lastPlanText = "";

  lastConfig = {
    gameMode,
    playMode,
    quickMode,
    teams: teams.map(t=>({name:t.name})),
    teamCount: teams.length
  };

  if (gameMode === "quiz"){
    startMcq(QUESTIONS_BASE, 10, "quiz");
  } else if (gameMode === "tf"){
    startMcq(TF_BASE, 10, "tf");
  } else if (gameMode === "order"){
    startOrder();
  } else if (gameMode === "sema"){
    startMcq(SEMA_BASE, 10, "sema");
  } else if (gameMode === "check"){
    startChecklist(CHECK_BASE, 8);
  } else if (gameMode === "myth"){
    startMcq(MYTH_BASE, 10, "myth");
  } else if (gameMode === "say"){
    startMcq(SAY_BASE, 10, "say");
  } else {
    startMcq(QUESTIONS_BASE, 10, "quiz");
  }
}

function startAgain(){
  // Repetir con la última config usada
  if (!lastConfig){
    resetAll();
    return;
  }

  gameMode = lastConfig.gameMode;
  playMode = lastConfig.playMode;
  quickMode = !!lastConfig.quickMode;

  if (playMode === "teams"){
    teams = lastConfig.teams.map((t, i)=>({ name: t.name || ("Equipo "+(i+1)), score: 0 }));
    activeTeam = 0;
  } else {
    teams = [];
    activeTeam = 0;
  }

  resetScores();
  breakdown = [];
  idx = 0;
  answered = false;
  followUpPending = false;
  lastPlanText = "";

  if (gameMode === "quiz"){
    startMcq(QUESTIONS_BASE, 10, "quiz");
  } else if (gameMode === "tf"){
    startMcq(TF_BASE, 10, "tf");
  } else if (gameMode === "order"){
    startOrder();
  } else if (gameMode === "sema"){
    startMcq(SEMA_BASE, 10, "sema");
  } else if (gameMode === "check"){
    startChecklist(CHECK_BASE, 8);
  } else if (gameMode === "myth"){
    startMcq(MYTH_BASE, 10, "myth");
  } else if (gameMode === "say"){
    startMcq(SAY_BASE, 10, "say");
  } else {
    startMcq(QUESTIONS_BASE, 10, "quiz");
  }
}

// ---------- MCQ (Quiz + TF) ----------
function gradePoints(g){
  if (g === "green") return 2;
  if (g === "amber") return 1;
  return 0;
}

function startMcq(bank, takeN, type){
  // tipo: quiz | tf | sema | myth | say
  QUESTIONS = deepCopyBank(bank);

  // Blindaje: asigna un id estable por respuesta antes de traducir/barajar
  QUESTIONS.forEach(q=>{
    if (Array.isArray(q.answers)){
      q.answers.forEach((a,i)=>{ if (a && typeof a === 'object' && a.__aid == null) a.__aid = i; });
    }
  });

  shuffle(QUESTIONS);
  QUESTIONS = QUESTIONS.slice(0, Math.min(takeN, QUESTIONS.length));
  // Aplica traducciones por idioma (si existen) antes de barajar
  QUESTIONS.forEach(q => applyQTranslation(type, q));

  // En multijugador mantenemos el orden de respuestas (así choice index coincide entre idiomas)
  const isMP = (typeof MP !== "undefined") && (MP.mode === "host" || MP.mode === "join");
  if (!isMP){
    QUESTIONS.forEach(q => shuffle(q.answers));
  }

  hide("start"); hide("result"); show("quiz");
  show("answers"); hide("orderArea"); hide("checkArea");

  idx = 0;
  answered = false;
  followUpPending = false;

  setState(t("state.playing","En curso"));
  renderQuestion(type);
}

function renderQuestion(type){
  answered = false;
  followUpPending = false;

  clearTimer();

  hide("feedback");
  hide("followUp");
  hide("btnNext");
  if ($("btnNext")){
    $("btnNext").disabled = false;
  }

  // MP host: resetea el estado de "Mostrar solución" al cambiar de pregunta
  if (typeof MP !== "undefined" && MP.started && MP.mode==="host" && MP.room){
    show("btnReveal");
    show("btnNext");
    resetBtnRevealUI();
  }

  // asegura áreas
  show("answers"); hide("orderArea"); hide("checkArea");

  const q = QUESTIONS[idx];
  // Re-aplica traducción por idioma al vuelo
  try{ applyQTranslation(type, q); }catch(_e){}

  updateProgressUI();
  updateScoreUI();

  $("qText").textContent = q.q;
  $("qHint").textContent = q.hint || "";

  const wrap = $("answers");
  wrap.innerHTML = "";

  const lettersDefault = ["A","B","C","D"];
  const lettersTF = ["V","F"];
  const letters = (type === "tf" && q.answers.length === 2) ? lettersTF : lettersDefault;

  q.answers.forEach((a, i)=>{
    const btn = document.createElement("button");
    btn.className = "ans";
    btn.type = "button";
    btn.innerHTML = `<span class="tag">${letters[i] || ""}</span><span class="text">${escapeHtml(a.txt)}</span>`;
    btn.addEventListener("click", ()=>selectAnswer(i, type, false));
    wrap.appendChild(btn);
  });

  // Semáforo: cuenta atrás
  if (type === "sema"){
    startTimer(5);
  } else {
    if ($("qTimer")) hide("qTimer");
  }
}

function revealAll(selectedIndex){
  const q = QUESTIONS[idx];
  const buttons = Array.from(document.querySelectorAll(".ans"));
  buttons.forEach((b, i)=>{
    const g = q.answers[i].grade;
    b.classList.add(g, "locked");
    b.disabled = true;
    if (i === selectedIndex) b.classList.add("selected");
  });
}

function findGreenAnswer(q){
  return q.answers.find(a=>a.grade==="green")?.txt || "(verde no definido)";
}

function usesGreenPlaceholder(s){
  return typeof s === "string" && s.includes("{{GREEN}}");
}

function selectAnswer(i, type, timedOut=false){
  if (answered) return;
  answered = true;

  clearTimer();

  const q = QUESTIONS[idx];

  let a = null;
  let pickTxt = "";
  let grade = "red";
  let why = "";

  if (timedOut || i < 0 || !q.answers || !q.answers[i]){
    pickTxt = t("fb.timeoutPick","⏱ Tiempo agotado");
    grade = "red";
    why = t("fb.timeoutWhy","No esperes a estar seguro al 100%: si hay exposición, prioriza parar/aislar y avisar.");
  } else {
    a = q.answers[i];
    pickTxt = a.txt;
    grade = a.grade;
    why = (a.why || "");
  }

  const pts = gradePoints(grade);

  addPoints(pts);
  revealAll(i);

  const greenTxt = findGreenAnswer(q);
  const titleEl = $("fbTitle");
  const bodyEl  = $("fbBody");

  const whyResolved = usesGreenPlaceholder(why) ? why.replaceAll("{{GREEN}}", greenTxt) : why;

  let title = "";
  let body  = "";

  const isEs = (I18N && I18N.lang === "es");

if (grade === "green"){
  title = t("fb.title.green","✅ Perfecto");
  body  = "✅ " + whyResolved;
} else if (grade === "amber"){
  title = t("fb.title.amber","🟠 Correcto… pero se puede hacer mejor");
  if (isEs){
    body = usesGreenPlaceholder(why)
      ? ("🟠 " + whyResolved)
      : ("🟠 " + whyResolved + "\n\n" + fmt(t("fb.mostCorrect","✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt}));
  } else {
    body = fmt(t("fb.body.amber","🟠 Bien, pero hay un canal más adecuado aquí.\n\n✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt});
  }
} else {
  title = t("fb.title.red","🔴 Incorrecto");
  if (isEs){
    body = usesGreenPlaceholder(why)
      ? ("🔴 " + whyResolved)
      : ("🔴 " + whyResolved + "\n\n" + fmt(t("fb.mostCorrect","✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt}));
  } else {
    body = fmt(t("fb.body.red","🔴 No es la mejor opción para seguridad.\n\n✅ Lo más correcto sería: {GREEN}"), {GREEN: greenTxt});
  }
}

  titleEl.textContent = title;
  bodyEl.textContent  = body;

  show("feedback");
  show("btnNext");

  breakdown.push({
    n: idx+1,
    q: q.q,
    pick: pickTxt,
    grade,
    pts,
    team: (playMode==="teams") ? (teams[activeTeam]?.name || "") : ""
  });

  updateScoreUI();
  const pct2 = Math.round(((idx+1) / Math.max(1, roundTotal())) * 100);
  if ($("bar")) $("bar").style.width = pct2 + "%";

  // Repregunta sólo en Kahoot (quiz) y sólo si rojo (modo rápido la desactiva)
  if (type === "quiz" && grade === "red" && !quickMode){
    showFollowUp(q);
  } else {
    hide("followUp");
    if ($("btnNext")) $("btnNext").disabled = false;
  }
}

function showFollowUp(q){
  followUpPending = true;

  // Repregunta preventiva: refuerzo de conducta (no “adivinar la verde”)
  const role = (q && q.bestRole) ? q.bestRole : "default";

  const BANK = {
    emergencia: [
      ()=>({
        q: "Primer minuto ante un accidente grave: ¿qué secuencia es la correcta?",
        options: [
          "Aseguro la zona, no muevo al herido, llamo al 112 e informo al mando.",
          "Lo levanto para que se siente y luego aviso.",
          "Espero a ver si se recupera y si eso aviso después.",
          "Lo llevo en coche sin valorar riesgos del entorno."
        ],
        correct: 0,
        hint: "Pista: primero seguridad + activar emergencia; no mover si puede agravar.",
        ok: "✅ Bien: control de la escena + 112 + comunicación interna."
      }),
      ()=>({
        q: "Al llamar al 112, ¿qué información es imprescindible dar?",
        options: [
          "Ubicación exacta + qué ha pasado + nº de heridos + riesgos presentes.",
          "Solo el nombre del encargado.",
          "Un audio largo sin indicar el punto exacto.",
          "Esperar a tener ‘todos los datos’ antes de llamar."
        ],
        correct: 0,
        hint: "Pista: ubicación y tipo de emergencia primero; lo demás se amplía después.",
        ok: "✅ Correcto: ubicación + tipo de emergencia + riesgos del entorno."
      })
    ],
    recurso: [
      ()=>({
        q: "Mientras avisas al recurso preventivo, ¿qué haces primero para reducir el riesgo?",
        options: [
          "Aseguro la zona (paro si procede), señalizo y evito exposición.",
          "Sigo trabajando y ya lo verá alguien.",
          "Lo dejo para el final del día.",
          "Me limito a comentarlo en el descanso."
        ],
        correct: 0,
        hint: "Pista: control temporal inmediato (parar/señalizar/aislar) antes de todo.",
        ok: "✅ Perfecto: control inmediato + aviso."
      }),
      ()=>({
        q: "¿Qué hace el recurso preventivo en obra cuando le avisas?",
        options: [
          "Verifica en campo y activa la corrección con mando/contratas.",
          "Sanciona a quien pille en el acto.",
          "Gestiona nóminas y cuadrantes.",
          "Solo toma nota para un informe mensual."
        ],
        correct: 0,
        hint: "Pista: su función es activar control real y seguimiento en obra.",
        ok: "✅ Exacto: presencia en campo y activación de correcciones."
      }),
      ()=>({
        q: "Si el mando no está localizable, ¿qué objetivo tiene avisar al recurso preventivo?",
        options: [
          "Activar corrección ya y evitar exposición mientras se localiza al mando.",
          "Saltarse al mando siempre.",
          "Guardar la incidencia para cuando haya tiempo.",
          "Delegar la responsabilidad y desentenderme."
        ],
        correct: 0,
        hint: "Pista: rapidez y control del riesgo en el momento.",
        ok: "✅ Bien: rapidez + control temporal del riesgo."
      })
    ],
    mando: [
      ()=>({
        q: "Tras el aviso, ¿qué debe decidir el mando antes de reanudar la tarea?",
        options: [
          "Paro/organizo y aplico medida colectiva o cambio de método seguro.",
          "Que aceleren para terminar cuanto antes.",
          "Que se pongan un EPI y sigan igual.",
          "Ignorar si no ha pasado nada todavía."
        ],
        correct: 0,
        hint: "Pista: primero eliminar/reducir el riesgo; el EPI no sustituye la medida colectiva.",
        ok: "✅ Correcto: parar/organizar y aplicar control eficaz."
      }),
      ()=>({
        q: "En prevención, ¿qué suele ir primero cuando hay riesgo en el puesto?",
        options: [
          "Protección colectiva/medida técnica antes que EPI.",
          "EPI siempre vale para todo y es lo primero.",
          "Señalizar y seguir como si nada.",
          "Esperar al informe final para actuar."
        ],
        correct: 0,
        hint: "Pista: jerarquía preventiva: colectivo/técnico antes que individual.",
        ok: "✅ Bien: prioridad a medidas colectivas/técnicas."
      })
    ],
    tecnico: [
      ()=>({
        q: "¿Cuándo tiene sentido escalar al técnico PRL?",
        options: [
          "Cuando requiere evaluación, procedimiento, medida técnica o formación.",
          "Para decidir temas de producción diarios.",
          "Solo si hay sanción de por medio.",
          "Siempre, aunque sea un tema menor resuelto en el momento."
        ],
        correct: 0,
        hint: "Pista: se escala cuando hace falta análisis técnico o procedimiento.",
        ok: "✅ Exacto: evaluación y medidas técnicas/procedimentales."
      }),
      ()=>({
        q: "¿Qué aporta el técnico PRL en un caso complejo?",
        options: [
          "Analiza causas y define medidas + seguimiento de implantación.",
          "Da un ok verbal sin ver la zona.",
          "Sustituye al mando en la obra.",
          "Solo rellena papeles sin ir a campo."
        ],
        correct: 0,
        hint: "Pista: análisis + propuesta + seguimiento.",
        ok: "✅ Bien: técnica + seguimiento."
      })
    ],
    css: [
      ()=>({
        q: "En interferencias entre empresas, ¿por qué avisar al CSS?",
        options: [
          "Para coordinar actividades/medidas y evitar interferencias (control real).",
          "Para que castigue a una contrata.",
          "Para que ejecute la tarea él.",
          "Solo para añadir burocracia."
        ],
        correct: 0,
        hint: "Pista: coordinación y control de interferencias.",
        ok: "✅ Correcto: coordinar para prevenir interferencias."
      }),
      ()=>({
        q: "¿Qué información clave darías al CSS en un aviso?",
        options: [
          "Zona/actividad + empresas implicadas + riesgo/interferencia + medida provisional.",
          "Un ‘hay lío’ sin detalles.",
          "Solo una foto sin ubicación.",
          "Una opinión sin datos verificables."
        ],
        correct: 0,
        hint: "Pista: datos operativos para coordinar ya.",
        ok: "✅ Bien: datos concretos y medida provisional."
      })
    ],
    delegado: [
      ()=>({
        q: "¿Cuándo es útil avisar al delegado de prevención?",
        options: [
          "Para canalizar propuestas/mejoras y casos reiterados no corregidos.",
          "Para emergencias médicas (112).",
          "Para autorizar trabajos en obra.",
          "Para sustituir al mando en decisiones diarias."
        ],
        correct: 0,
        hint: "Pista: participación, propuestas y seguimiento de reiteraciones.",
        ok: "✅ Correcto: canal de participación y mejora."
      }),
      ()=>({
        q: "Si un problema se repite, ¿qué enfoque organizativo ayuda más?",
        options: [
          "Registrar, proponer mejora y elevar por vía de participación.",
          "Callar para no molestar.",
          "Arreglarlo ‘como pueda’ cada día sin avisar.",
          "Culpar sin evidencias."
        ],
        correct: 0,
        hint: "Pista: organización + seguimiento, no parches silenciosos.",
        ok: "✅ Bien: registro + propuesta + participación."
      })
    ],
    default: [
      ()=>({
        q: "Además de avisar, ¿qué haces primero para controlar el riesgo?",
        options: [
          "Aseguro la zona: paro si procede, señalizo y evito exposición.",
          "Espero a que lo vea alguien y sigo trabajando.",
          "Lo comento en el descanso y ya.",
          "Me limito a hacer una foto y me voy."
        ],
        correct: 0,
        hint: "Pista: control temporal del riesgo (parar/señalizar/aislar).",
        ok: "✅ Perfecto: primero control, luego comunicación."
      }),
      ()=>({
        q: "En un aviso preventivo eficaz, ¿qué 3 datos no pueden faltar?",
        options: [
          "Ubicación exacta + qué pasa (riesgo) + medida provisional aplicada.",
          "Nombre del responsable + opinión personal + hora.",
          "Un audio largo sin ubicación clara.",
          "Solo “vente” sin contexto."
        ],
        correct: 0,
        hint: "Pista: ubicación + riesgo + control provisional.",
        ok: "✅ Bien: información accionable."
      })
    ]
  };

  const list = BANK[role] || BANK.default;
  const genIdx = Math.floor(Math.random()*list.length);
  const fu = list[genIdx]();
  fu.id = role + "_" + (genIdx+1);
  applyFUTranslation(fu);

  $("fuQ").textContent = fu.q;
  $("fuNote").textContent = "";

  const wrap = $("fuAnswers");
  wrap.innerHTML = "";

  const opts = fu.options.map((t, idx)=>({ txt: t, ok: idx === fu.correct }));
  shuffle(opts);

  opts.forEach((o)=>{
    const b = document.createElement("button");
    b.className = "fuBtn";
    b.type = "button";
    b.textContent = o.txt;
    b.addEventListener("click", ()=>{
      if (o.ok){
        followUpPending = false;
        $("fuNote").textContent = fu.ok || t("fu.okDefault","✅ Bien. Seguimos.");
        if ($("btnNext")) $("btnNext").disabled = false;
      } else {
        $("fuNote").textContent = "❌ " + (fu.hint || "Pista: piensa en la medida preventiva inmediata.");
        if ($("btnNext")) $("btnNext").disabled = true;
      }
    });
    wrap.appendChild(b);
  });

  if ($("btnNext")) $("btnNext").disabled = true;
  show("followUp");
}

// ---------- Ordena (drag) ----------
let orderChecked = false;

function startOrder(){
  ORDER_SET = ORDER_BASE.map(o=>({ ...o, steps: o.steps.slice() }));
  // i18n (traduce pasos y explicación)
  ORDER_SET.forEach(o=>applyQTranslation("order", o));
  shuffle(ORDER_SET);
  ORDER_SET = ORDER_SET.slice(0, Math.min(3, ORDER_SET.length));

  hide("start"); hide("result"); show("quiz");
  hide("answers"); show("orderArea"); hide("checkArea");

  idx = 0;
  answered = false;
  orderChecked = false;
  followUpPending = false;

  setState(t("state.playing","En curso"));
  renderOrderRound();
}

function renderOrderRound(){
  answered = false;
  orderChecked = false;
  hide("feedback");
  hide("btnNext");
  if ($("btnNext")) $("btnNext").disabled = false;

  const o = ORDER_SET[idx];

  updateProgressUI();
  updateScoreUI();

  $("qText").textContent = o.q;
  $("qHint").textContent = o.hint || "";

  // construir tarjetas
  const list = $("orderList");
  list.innerHTML = "";

  const cards = o.steps.map((txt, correctIndex)=>({ txt, correctIndex }));
  shuffle(cards);

  cards.forEach((c, i)=>{
    const div = document.createElement("div");
    div.className = "cardItem";
    div.draggable = true;
    div.dataset.correctIndex = String(c.correctIndex);
    div.dataset.id = String(i);
    div.innerHTML = `<small>${escapeHtml(t("order.drag","Arrastra"))}</small><div>${escapeHtml(c.txt)}</div>`;

    div.addEventListener("dragstart", (ev)=>{
      div.classList.add("dragging");
      ev.dataTransfer.setData("text/plain", div.dataset.id);
      ev.dataTransfer.effectAllowed = "move";
    });
    div.addEventListener("dragend", ()=>{
      div.classList.remove("dragging");
    });

    list.appendChild(div);
  });

  // drop handler
  list.ondragover = (ev)=>{
    ev.preventDefault();
    const dragging = list.querySelector(".dragging");
    if (!dragging) return;

    const after = getDragAfterElement(list, ev.clientY);
    if (after == null){
      list.appendChild(dragging);
    } else {
      list.insertBefore(dragging, after);
    }
  };

  if ($("btnCheckOrder")){
    $("btnCheckOrder").disabled = false;
    $("btnCheckOrder").onclick = checkOrder;
  }
}

function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll(".cardItem:not(.dragging)")];
  return els.reduce((closest, child)=>{
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if (offset < 0 && offset > closest.offset){
      return { offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
}

function checkOrder(){
  if (orderChecked) return;
  orderChecked = true;

  const o = ORDER_SET[idx];
  const list = $("orderList");
  const items = Array.from(list.querySelectorAll(".cardItem"));

  // bloquear drag
  items.forEach(it=>{
    it.draggable = false;
    it.style.cursor = "default";
  });

  let correct = 0;
  items.forEach((it, pos)=>{
    if (parseInt(it.dataset.correctIndex,10) === pos) correct++;
  });

  const total = items.length;
  let pts = 0;
  let grade = "red";
  if (correct === total){
    pts = 2; grade = "green";
  } else if (correct >= total - 1){
    pts = 1; grade = "amber";
  } else {
    pts = 0; grade = "red";
  }

  addPoints(pts);

  const titleEl = $("fbTitle");
  const bodyEl  = $("fbBody");

  if (grade === "green"){
    titleEl.textContent = t("check.title.green","✅ Perfecto");
  } else if (grade === "amber"){
    titleEl.textContent = t("order.title.amber","🟠 Casi");
  } else {
    titleEl.textContent = t("order.title.red","🔴 No del todo");
  }

  const correctOrder = o.steps.map((s, i)=>`${i+1}) ${s}`).join("\n");
  bodyEl.textContent = fmt(
    t("order.body",
      "Tu orden tiene {CORRECT}/{TOTAL} posiciones correctas.\n\n✅ Orden recomendado:\n{ORDER}\n\n💡 {WHY}"
    ),
    { CORRECT: correct, TOTAL: total, ORDER: correctOrder, WHY: o.why }
  );

  show("feedback");
  show("btnNext");
  answered = true;

  breakdown.push({
    n: idx+1,
    q: o.q,
    pick: t("order.pick","Ordenado (ver explicación)"),
    grade,
    pts,
    team: (playMode==="teams") ? (teams[activeTeam]?.name || "") : ""
  });

  updateScoreUI();
  const pct2 = Math.round(((idx+1) / Math.max(1, roundTotal())) * 100);
  if ($("bar")) $("bar").style.width = pct2 + "%";
}

// ---------- Siguiente / fin ----------
function next(){
  if (!answered) return;
  if (followUpPending) return;

  const total = roundTotal();

  if (idx < total - 1){
    idx++;
    rotateTeam();

    if (gameMode === "order"){
      renderOrderRound();
    } else if (gameMode === "check"){
      renderChecklistRound();
    } else {
      renderQuestion(gameMode);
    }
  } else {
    finish();
  }
}

function renderTeamBoard(){
  let el = $("teamBoard");

  // Micro-parche: si el contenedor no existe, lo creamos (evita que el modo equipos se quede sin TeamBoard).
  if (!el){
    const anchor = $("finalDetail") || $("finalScore");
    const host = anchor?.parentElement || $("result");
    if (!host) return;

    el = document.createElement("div");
    el.id = "teamBoard";
    el.className = "teamBoard hidden";

    if (anchor) anchor.insertAdjacentElement("afterend", el);
    else host.appendChild(el);
  }

  if (playMode !== "teams"){
    el.classList.add("hidden");
    el.innerHTML = "";
    return;
  }

  el.classList.remove("hidden");
  el.innerHTML = `
    <div class="th">${escapeHtml(t("team.col.team","Equipo"))}</div>
    <div class="th">${escapeHtml(t("team.col.points","Puntos"))}</div>
    ${teams.map(t=>`<div>${esc(t.name)}</div><div>${t.score}</div>`).join("")}
  `;
}


function buildActionPlan(pct){
  const tier = (pct >= 85) ? "high" : (pct >= 60) ? "mid" : "low";

  const fallback = {
    high: {
      preventivas: [
        "Refuerza: protección colectiva primero (barandillas, redes, tapas).",
        "Define y señaliza zonas de exclusión (balizamiento real).",
        "Verifica equipos (escaleras, herramientas, discos) antes de uso."
      ],
      organizativas: [
        "Briefing de 2 min al inicio: riesgos del día + control.",
        "Canal de aviso claro: mando → recurso → PRL; y cuándo 112.",
        "Registro de reincidencias y cierre (responsable + fecha)."
      ],
      mision: [
        "Haz una “vuelta de 60 s”: detecta 1 riesgo y actúa (aislar/avisar).",
        "Di en voz alta: ubicación + riesgo + control provisional + qué necesitas."
      ]
    },
    mid: {
      preventivas: [
        "Prioriza control inmediato: parar/aislar antes de avisar.",
        "Mejora orden y limpieza en zonas de paso.",
        "EPI como complemento: verifica adecuación y uso."
      ],
      organizativas: [
        "Alinea quién decide paradas y cómo se comunica.",
        "Comprueba que señalización y vías están libres.",
        "Si hay varias contratas: coordina (CSS/CAE)."
      ],
      mision: [
        "Elige 1 tarea y define su “primero”: ¿qué harías en 5 s?",
        "Escribe 1 aviso modelo al mando (3 líneas)."
      ]
    },
    low: {
      preventivas: [
        "Revisa jerarquía: evita el riesgo en origen antes que EPI.",
        "No improvises: pide procedimiento/criterio y asegura la tarea.",
        "Corta la exposición: aisla zonas peligrosas."
      ],
      organizativas: [
        "Acuerda un protocolo STOP WORK: quién para y quién corrige.",
        "Refuerza formación breve en riesgos críticos (alturas, izado, electricidad).",
        "Haz seguimiento: cada aviso debe tener cierre."
      ],
      mision: [
        "Practica: “paro – aíslo – aviso” en un ejemplo real de obra.",
        "En equipo: cada persona aporta 1 control inmediato."
      ]
    }
  };

  const prev = uiAny(`plan.${tier}.preventivas`, null);
  const org  = uiAny(`plan.${tier}.organizativas`, null);
  const mis  = uiAny(`plan.${tier}.mision`, null);

  return {
    preventivas: Array.isArray(prev) ? prev : fallback[tier].preventivas,
    organizativas: Array.isArray(org) ? org : fallback[tier].organizativas,
    mision: Array.isArray(mis) ? mis : fallback[tier].mision
  };
}

function renderActionPlan(){
  const box = $("actionPlan");
  if (!box) return;

  // Solo en individual (no teams ni multijugador)
  const isMPActive = (typeof MP !== "undefined") && (MP.role && MP.role !== "none");
  const isSolo = (playMode === "solo" || playMode === "single");
  if (isMPActive || !isSolo){
    box.innerHTML = "";
    box.classList.add("hidden");
    hide("btnCopyPlan");
    hide("copyOk");
    return;
  }
  box.classList.remove("hidden");
  show("btnCopyPlan");
  hide("copyOk");

  const pct = scorePercent();
  const plan = buildActionPlan(pct);

  const hPrev = t("plan.section.preventivas","Medidas preventivas");
  const hOrg  = t("plan.section.organizativas","Medidas organizativas");
  const hMis  = t("plan.section.mision","Misión rápida (para mañana)");

  box.innerHTML = `
    <h3 class="planTitle" data-i18n="plan.title">${escapeHtml(t("plan.title","Tu plan de acción"))}</h3>
    <div class="planGrid">
      <div class="planCol">
        <h4>${escapeHtml(hPrev)}</h4>
        <ul>${plan.preventivas.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
      </div>
      <div class="planCol">
        <h4>${escapeHtml(hOrg)}</h4>
        <ul>${plan.organizativas.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
      </div>
      <div class="planCol">
        <h4>${escapeHtml(hMis)}</h4>
        <ul>${plan.mision.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
      </div>
    </div>
  `;

  // pre-genera texto copiable (en idioma actual)
  const total = totalScore();
  const max = maxScore();
  const lines = [];

  lines.push(t("plan.copy.header","PLAN DE ACCIÓN (resumen)"));
  lines.push(fmt(t("plan.copy.result","Resultado: {TOTAL}/{MAX} ({PCT}%)"), {TOTAL: total, MAX: max, PCT: pct}));

  if (playMode === "teams"){
    lines.push("");
    lines.push(t("plan.copy.scoreboard","Marcador:"));
    teams.forEach(ti=>{
      lines.push(`- ${ti.name}: ${ti.score} ${t("plan.copy.pts","pts")}`);
    });
  }

  lines.push("");
  lines.push(hPrev + ":");
  plan.preventivas.forEach(x=> lines.push(`- ${x}`));

  lines.push("");
  lines.push(hOrg + ":");
  plan.organizativas.forEach(x=> lines.push(`- ${x}`));

  lines.push("");
  lines.push(hMis + ":");
  plan.mision.forEach(x=> lines.push(`- ${x}`));

  lastPlanText = lines.join("\n");
}

async function copyPlan(){
  if (!lastPlanText) return;
  try{
    await navigator.clipboard.writeText(lastPlanText);
    show("copyOk");
    setTimeout(()=>hide("copyOk"), 1600);
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = lastPlanText;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ document.execCommand("copy"); }catch(_){}
    document.body.removeChild(ta);
    show("copyOk");
    setTimeout(()=>hide("copyOk"), 1600);
  }
}

function finish(){
  hide("quiz"); show("result");
  setState(t("state.done","Finalizado"));

  const max = maxScore();
  const total = totalScore();
  const pct = scorePercent();

  $("finalScore").textContent = fmt(
    t("result.scoreMain","{TOTAL}/{MAX} ({PCT}%)"),
    { TOTAL: total, MAX: max, PCT: pct }
  );

  const modeLabel = t(`mode.${gameMode}`, 
    (gameMode==="quiz")  ? "Kahoot (test)" :
    (gameMode==="tf")    ? "Verdadero/Falso" :
    (gameMode==="order") ? "Ordena la actuación" :
    (gameMode==="sema")  ? "Semáforo (5 s)" :
    (gameMode==="check") ? "Checklist express" :
    (gameMode==="myth")  ? "Frase trampa" :
    (gameMode==="say")   ? "¿Qué le digo al mando?" :
    "Juego"
  );

  $("finalDetail").textContent = fmt(
    t("result.detail","Modo: {MODE} · Verde = 2 · Naranja = 1 · Roja = 0 · Total rondas: {ROUNDS}"),
    { MODE: modeLabel, ROUNDS: roundTotal() }
  );

  renderTeamBoard();
  renderActionPlan();

  const wrap = $("breakdown");
  wrap.innerHTML = "";
  breakdown.forEach(b=>{
    const div = document.createElement("div");
    div.className = "item";
    const badgeClass = b.grade === "green" ? "green" : (b.grade === "amber" ? "amber" : "red");
    const badgeTxt   = b.grade === "green" ? t("badge.green","Verde") : (b.grade === "amber" ? t("badge.amber","Naranja") : t("badge.red","Roja"));
    const teamTxt = (playMode==="teams" && b.team) ? ` · ${escapeHtml(b.team)}` : "";
    const roundLabel = fmt(t("result.roundLabel","R{N}"), {N: b.n});
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <small>${escapeHtml(roundLabel)}${teamTxt}</small>
        <span class="badge ${badgeClass}">${escapeHtml(badgeTxt)} · +${b.pts}</span>
      </div>
      <div style="margin-top:6px;font-size:13px;line-height:1.25">${escapeHtml(b.q)}</div>
      <small style="display:block;margin-top:6px">${escapeHtml(t("result.yourAnswer","Tu respuesta:"))} ${escapeHtml(b.pick)}</small>
    `;
    wrap.appendChild(div);
  });
}


// ---------- STOP WORK ----------
function openStopWork(){
  const ov = $("stopWorkOverlay");
  if (!ov) return;

  // carga último
  const last = safeJsonParse(lsGet("sw_last") || "{}");
  if ($("swLoc")) $("swLoc").value = last.loc || "";
  if ($("swRisk")) $("swRisk").value = last.risk || "";
  if ($("swControl")) $("swControl").value = last.control || t("sw.default.control","He parado la tarea y he señalizado/aislado la zona.");
  if ($("swNeed")) $("swNeed").value = last.need || t("sw.default.need","Que venga el mando/recurso para corregir y dejar constancia.");

  updateStopMsg();
  show("stopWorkOverlay");
}

function closeStopWork(){
  hide("stopWorkOverlay");
  if ($("swCopied")) hide("swCopied");
}

function updateStopMsg(){
  const loc = ($("swLoc")?.value || "").trim();
  const risk = ($("swRisk")?.value || "").trim();
  const control = ($("swControl")?.value || "").trim();
  const need = ($("swNeed")?.value || "").trim();

  const dash = t("dash","—");
  const msg =
`${t("sw.msg.header","STOP WORK")}
${t("sw.msg.loc","Ubicación")}: ${loc || dash}
${t("sw.msg.risk","Riesgo")}: ${risk || dash}
${t("sw.msg.control","Control provisional")}: ${control || dash}
${t("sw.msg.need","Necesito")}: ${need || dash}`;

  if ($("swMsg")) $("swMsg").textContent = msg;

  // guarda
  lsSet("sw_last", JSON.stringify({ loc, risk, control, need }));
}


function copyStopMsg(){
  const t = $("swMsg")?.textContent || "";
  if (!t) return;
  try{
    navigator.clipboard.writeText(t).then(()=>{
      show("swCopied");
      setTimeout(()=>hide("swCopied"), 1200);
    }).catch(()=>{ throw new Error("clipboard"); });
  }catch(e){
    // fallback (file:// y algunos navegadores)
    const ta = document.createElement("textarea");
    ta.value = t;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ document.execCommand("copy"); }catch(_){}
    document.body.removeChild(ta);
    show("swCopied");
    setTimeout(()=>hide("swCopied"), 1200);
  }
}

function safeJsonParse(s){
  try { return JSON.parse(s); } catch(e){ return {}; }
}

// ---------- Init ----------
window.addEventListener("DOMContentLoaded", ()=>{
  initBgTheme();
  updateStartUI();
$("playMode")?.addEventListener("change", updateStartUI);
  $("teamCount")?.addEventListener("change", updateStartUI);
  $("gameMode")?.addEventListener("change", updateStartUI);
  $("quizPace")?.addEventListener("change", updateStartUI);
  $("bgTheme")?.addEventListener("change", ()=>applyBgTheme($("bgTheme")?.value || "night", true));

  $("btnStart")?.addEventListener("click", onStartClick);
  $("btnReset")?.addEventListener("click", onExitClick);

  $("btnBackToStart")?.addEventListener("click", onExitClick);
  $("btnNext")?.addEventListener("click", onNextClick);

  $("btnAgain")?.addEventListener("click", startAgain);
  $("btnToStart")?.addEventListener("click", resetAll);



  // STOP WORK (siempre disponible)
  $("btnStopWork")?.addEventListener("click", openStopWork);
  $("btnCloseStop")?.addEventListener("click", closeStopWork);
  $("btnCopyStop")?.addEventListener("click", copyStopMsg);
  ["swLoc","swRisk","swControl","swNeed"].forEach(id => $(id)?.addEventListener("input", updateStopMsg));
  $("stopWorkOverlay")?.addEventListener("click", (e)=>{
    if (e.target && e.target.id === "stopWorkOverlay") closeStopWork();
  });
  $("btnCopyPlan")?.addEventListener("click", copyPlan);
});


// =======================
// Multijugador (Firebase RTDB) — Refactor estable (sin "parche sobre parche")
// =======================

// 1) Config Firebase (REEMPLAZA con tu config del panel de Firebase -> "Añadir app web")
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBXahJg5L3fV94v5q27uYDDC9NJvjHpFV0",
  authDomain: "digitalizacion-prevencion.firebaseapp.com",
  databaseURL: "https://digitalizacion-prevencion-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "digitalizacion-prevencion",
  storageBucket: "digitalizacion-prevencion.firebasestorage.app",
  messagingSenderId: "271798265443",
  appId: "1:271798265443:web:24a4247a006c874ddcba56"
};

const MP = {
  mode: "local",           // local | host | join   (valor del selector)
  role: "none",            // none | host | join    (sesión activa)
  room: "",
  pid: "",
  pname: "",
  plang: "es",
  gameId: "",
  qIds: [],
  qIndex: 0,
  current: null,
  answeredThisRound: false,
  selectedIndex: null,
  lastRoundId: null,

  unsubState: null,
  unsubAnswers: null,
  unsubPlayers: null
};

function mpIsConfigured(){
  try{
    return !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.databaseURL);
  }catch(_e){ return false; }
}

function mpSetPill(txt){
  const p = $("pillState");
  if (p) p.textContent = txt;
}

function mpCleanup(){
  if (MP.unsubState){ try{ MP.unsubState(); }catch(_e){} MP.unsubState = null; }
  if (MP.unsubAnswers){ try{ MP.unsubAnswers(); }catch(_e){} MP.unsubAnswers = null; }
  if (MP.unsubPlayers){ try{ MP.unsubPlayers(); }catch(_e){} MP.unsubPlayers = null; }
  MP.role = "none";
  MP.room = "";
  MP.pid = "";
  MP.pname = "";
  MP.gameId = "";
  MP.qIds = [];
  MP.qIndex = 0;
  MP.current = null;
  MP.answeredThisRound = false;
  MP.selectedIndex = null;
}

function mpReadModeFromUI(){
  MP.mode = $("sessionMode")?.value || "local";
  return MP.mode;
}

function mpForceQuizModeInRoom(){
  // En sala multijugador, por simplicidad solo soportamos Kahoot (quiz)
  if ($("gameMode") && $("gameMode").value !== "quiz") $("gameMode").value = "quiz";
  if ($("gameMode")) $("gameMode").disabled = (MP.mode === "host" || MP.mode === "join");
  if ($("quizPaceWrap")) show("quizPaceWrap");
  if ($("sessionLimitNote")){
    if (MP.mode === "host" || MP.mode === "join") show("sessionLimitNote");
    else hide("sessionLimitNote");
  }
}

function mpSetStartButtonLabel(){
  const b = $("btnStart");
  if (!b) return;

  // local
  if (MP.mode === "local"){
    b.textContent = (I18N.ui["btn.start"] || "Empezar");
    b.disabled = false;
    return;
  }

  // host
  if (MP.mode === "host"){
    if (!MP.room){
      b.textContent = (I18N.ui["btn.createRoom"] || "Crear sala");
      b.disabled = false;
      return;
    }
    // si hay sala pero aún no se ha empezado
    const phase = MP.current?.phase || "lobby";
    if (phase === "lobby"){
      b.textContent = (I18N.ui["btn.startRoom"] || "Empezar partida");
      b.disabled = false;
    } else {
      b.textContent = (I18N.ui["btn.inProgress"] || "En curso");
      b.disabled = true;
    }
    return;
  }

  // join
  if (MP.mode === "join"){
    b.textContent = (I18N.ui["btn.start"] || "Empezar");
    b.disabled = true; // el joiner usa su propio botón "Unirme"
  }
}

function showSessionUI(){
  mpReadModeFromUI();

  // UI de host/join
  if (MP.mode === "host"){
    show("hostWrap"); hide("joinWrap");
  } else if (MP.mode === "join"){
    hide("hostWrap"); show("joinWrap");
  } else {
    hide("hostWrap"); hide("joinWrap");
  }

  // En modo JOIN (antesala), no mostramos controles de configuración del juego.
  const isJoin = (MP.mode === "join");

  const setFieldWrapVisible = (inputId, visible)=>{
    const el = document.getElementById(inputId);
    const wrap = el ? el.closest("label.field") : null;
    if (wrap) wrap.style.display = visible ? "" : "none";
  };
  const setByIdVisible = (id, visible)=>{
    const el = document.getElementById(id);
    if (el) el.style.display = visible ? "" : "none";
  };

  // Config (solo host/local)
  setFieldWrapVisible("gameMode", !isJoin);
  setFieldWrapVisible("playMode", !isJoin);
  setByIdVisible("quizPaceWrap", !isJoin);
  setFieldWrapVisible("bgTheme", !isJoin);
  setByIdVisible("teamCountWrap", !isJoin);
  if (isJoin){ hide("teamNames"); }

  // Botones locales (joiners usan "Unirme")
  const bStart = document.getElementById("btnStart");
  const bReset = document.getElementById("btnReset");
  if (bStart) bStart.style.display = isJoin ? "none" : "";
  if (bReset) bReset.style.display = isJoin ? "none" : "";

  mpForceQuizModeInRoom();

  // aviso config
  if ((MP.mode === "host" || MP.mode === "join") && !mpIsConfigured()){
    mpSetPill("⚠ Config Firebase pendiente");
  } else {
    mpSetPill("Listo");
  }

  mpSetStartButtonLabel();
}

function genRoomCode(){
  return String(Math.floor(100000 + Math.random()*900000));
}

function currentPageUrlNoQuery(){
  const origin = location.origin && location.origin !== "null" ? location.origin : "";
  if (!origin) return "";
  const u = new URL(location.href);
  u.hash = "";
  u.search = "";
  const p = u.pathname || "/";
  if (p.endsWith("/")) u.pathname = p + "index.html";
  else if (!/\.[a-z0-9]+$/i.test(p)) u.pathname = p + "/index.html";
  return u.toString();
}

function makeJoinUrl(code){
  const base = currentPageUrlNoQuery();
  if (!base) return "";
  const u = new URL(base);
  u.searchParams.set("join", String(code || ""));
  return u.toString();
}

function renderRoomBox(){
  if ($("roomCode")) $("roomCode").textContent = MP.room || "—";

  const link = MP.room ? makeJoinUrl(MP.room) : "";
  const linkEl = $("roomLink");
  if (linkEl){
    if (!MP.room) linkEl.textContent = "Enlace: —";
    else if (!link) linkEl.textContent = "⚠️ Abre esta página desde un servidor (http/https) para generar el QR.";
    else linkEl.textContent = "Link: " + link;
  }

  const roomQr = $("roomQr");
  if (!roomQr) return;
  roomQr.innerHTML = "";

  const qrSize = Math.max(120, Math.min(320, roomQr.clientWidth || 180));
  const empty = (msg)=>{ roomQr.innerHTML = `<div style="font-size:12px;color:var(--muted);text-align:center;padding:8px">${msg}</div>`; };

  if (!link){
    empty("QR no disponible");
    return;
  }

  const tryApiFallback = ()=>{
    const img = document.createElement("img");
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(link)}`;
    img.alt = "QR";
    img.width = qrSize; img.height = qrSize;
    img.style.imageRendering = "pixelated";
    img.referrerPolicy = "no-referrer";
    img.onerror = ()=> empty("No se pudo generar el QR");
    roomQr.appendChild(img);
  };

  try{
    if (window.QRCode && typeof window.QRCode.toCanvas === "function"){
      const canvas = document.createElement("canvas");
      window.QRCode.toCanvas(canvas, link, { width: qrSize, margin: 1, errorCorrectionLevel: "M" }, (err)=>{
        if (err){ tryApiFallback(); return; }
        roomQr.appendChild(canvas);
      });
      return;
    }
    if (window.QRCode && typeof window.QRCode.toDataURL === "function"){
      window.QRCode.toDataURL(link, { width: qrSize, margin: 1, errorCorrectionLevel: "M" }, (err, url)=>{
        if (err || !url){ tryApiFallback(); return; }
        const img = document.createElement("img");
        img.src = url;
        img.alt = "QR";
        img.width = qrSize; img.height = qrSize;
        img.style.imageRendering = "pixelated";
        roomQr.appendChild(img);
      });
      return;
    }
    tryApiFallback();
  }catch(_e){
    tryApiFallback();
  }
}

async function mpSubscribePlayers(){
  // Actualiza "Participantes" en lobby (host y joiners)
  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, onValue } = fb;

  if (MP.unsubPlayers){ try{ MP.unsubPlayers(); }catch(_e){} MP.unsubPlayers=null; }

  MP.unsubPlayers = onValue(ref(db, `rooms/${MP.room}/players`), (snap)=>{
    const obj = snap.val() || {};
    const n = Object.keys(obj).length;
    const el = $("waitingPlayers");
    if (el) el.textContent = fmt(t("mp.players","{N} participantes"), {N:n});
  }, (err)=>console.error(err));
}

async function mpSubscribeState(){
  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, onValue } = fb;

  if (MP.unsubState){ try{ MP.unsubState(); }catch(_e){} MP.unsubState=null; }

  MP.unsubState = onValue(ref(db, `rooms/${MP.room}/state`), (snap)=>{
    const st = snap.val();
    MP.current = st || null;
    mpSetStartButtonLabel();
    handleStateChange(st);
  }, (err)=>console.error(err));
}

async function mpCreateRoom(){
  if (!mpIsConfigured()){
    alert("Falta configurar Firebase. Revisa FIREBASE_CONFIG (incluye databaseURL) dentro del HTML.");
    return;
  }

  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, set, serverTimestamp, onDisconnect } = fb;

  // Genera código y crea estructura limpia
  const code = genRoomCode();
  MP.role = "host";
  MP.room = code;
  MP.plang = currentLang();

  // meta + state (lobby)
  await set(ref(db, `rooms/${code}/meta`), {
    createdAt: serverTimestamp(),
    title: document.title || "Juego PRL",
    hostLang: MP.plang
  });
  await set(ref(db, `rooms/${code}/state`), {
    phase: "lobby",
    ts: serverTimestamp()
  });

  // best-effort: si el host cierra pestaña, borra la sala
  try{
    onDisconnect(ref(db, `rooms/${code}`)).remove();
  }catch(_e){}

  renderRoomBox();
  mpSetPill("Sala: " + code);

  // Suscribe para tener MP.current siempre coherente
  await mpSubscribeState();
  await mpSubscribePlayers();

  mpSetStartButtonLabel();
}

async function mpCloseRoom(){
  if (!MP.room) { onExitClick(); return; }

  try{
    const fb = await window.__getFirebase(FIREBASE_CONFIG);
    const { db, ref, remove } = fb;
    await remove(ref(db, `rooms/${MP.room}`));
  }catch(e){
    console.error(e);
  }

  mpCleanup();
  mpSetPill("Listo");
  resetAll();
  showSessionUI();
}

function mpPickQuestions(total=10){
  const base = (typeof QUESTIONS_BASE !== "undefined" && Array.isArray(QUESTIONS_BASE)) ? QUESTIONS_BASE.slice() : [];
  shuffle(base);
  const picked = base.slice(0, Math.max(1, Math.min(total, base.length)));
  return picked.map(q=>q.id);
}

function mpMakeAnswerOrder(qRaw){
  const n = (qRaw && Array.isArray(qRaw.answers)) ? qRaw.answers.length : 4;
  const order = Array.from({length:n}, (_,i)=>i);
  shuffle(order);
  return order;
}

function mpBuildQ(qId, answerOrder){
  const qRaw = (typeof QUESTIONS_BASE !== "undefined" && Array.isArray(QUESTIONS_BASE)) ? QUESTIONS_BASE.find(x=>x.id===qId) : null;
  if (!qRaw) return null;

  const q = JSON.parse(JSON.stringify(qRaw));
  applyQTranslation("quiz", q);

  if (Array.isArray(answerOrder) && Array.isArray(q.answers) && answerOrder.length === q.answers.length){
    const old = q.answers.slice();
    q.answers = answerOrder.map(i=>old[i]);
  }
  return { q, qRaw };
}

function mpRenderLobby(){
  // Joiners: pantalla espera
  if (MP.role === "join"){
    hide("start"); hide("quiz"); hide("result");
    show("waiting");
    const roomTxt = fmt(t("mp.room","Sala {C}"), {C:(MP.room || "—")});
    if ($("waitingRoom")) $("waitingRoom").textContent = roomTxt;
    // waitingPlayers lo actualiza mpSubscribePlayers()
    return;
  }

  // Host: se queda en pantalla de sala (start)
  show("start");
  hide("waiting"); hide("quiz"); hide("result");
  renderRoomBox();
}

function mpRenderQuestion(st){
  hide("start"); hide("waiting"); hide("result");
  show("quiz");

  // reset de flags solo si es una ronda nueva (evita que cambiar idioma o re-render borre la selección)
  const _rid = st?.roundId || null;
  const _newRound = (!_rid) ? true : (_rid !== MP.lastRoundId);
  if (_newRound){
    MP.lastRoundId = _rid;
    MP.answeredThisRound = false;
    MP.selectedIndex = null;
  }

  const qId = st?.qId;
  const answerOrder = st?.answerOrder;
  const built = mpBuildQ(qId, answerOrder);
  const q = built ? built.q : null;

  $("qCounter").textContent = fmt(t("mp.qCounter","Pregunta {N}/{T}"), {N:(st.qNo||1), T:(st.total||10)});
  $("qScore").textContent = (MP.role === "host") ? t("mp.host","Host") : t("mp.inRoom","En sala");

  if ($("bar")){
    const pct = Math.round(((st.qNo || 1) / Math.max(1, st.total || 10)) * 100);
    $("bar").style.width = pct + "%";
  }

  $("qText").textContent = q ? (q.q || "—") : "—";
  $("qHint").textContent = q ? (q.hint || "") : "";

  hide("feedback");
  hide("followUp");

  const wrap = $("answers");
  wrap.innerHTML = "";
  const letters = ["A","B","C","D"];

  const answers = (q && Array.isArray(q.answers)) ? q.answers : [];
  answers.forEach((a, i)=>{
    const btn = document.createElement("button");
    btn.className = "ans";
    btn.type = "button";
    btn.innerHTML = `<span class="tag">${letters[i] || ""}</span><span class="text">${escapeHtml(a.txt || "")}</span>`;

    if (MP.role === "host"){
      btn.disabled = true; // el host no responde
      btn.classList.add("locked");
    } else {
      btn.addEventListener("click", ()=>mpJoinSelect(i));
    }
    wrap.appendChild(btn);
  });

  // Contadores solo host
  if (MP.role === "host") show("liveCounts"); else hide("liveCounts");

  // Botonera
  if (MP.role === "host"){
    show("btnReveal"); hide("btnNext");
    resetBtnRevealUI();
  } else {
    hide("btnReveal"); hide("btnNext");
  }
}

function mpRenderResults(st){
  hide("start"); hide("waiting"); hide("result");
  show("quiz"); // reutilizamos UI de quiz para mostrar solución, como en Kahoot

  const ended = !!st?.ended;
  const qId = st?.qId;
  const answerOrder = st?.answerOrder;
  const correctIndex = (typeof st?.correctIndex === "number") ? st.correctIndex : null;

  const built = mpBuildQ(qId, answerOrder);
  const q = built ? built.q : null;
  const qRaw = built ? built.qRaw : null;

  $("qCounter").textContent = ended
    ? (I18N.ui["mp.endedTitle"] || "Fin de la sala")
    : fmt(t("mp.qCounter","Pregunta {N}/{T}"), {N:(st.qNo||1), T:(st.total||10)});
  $("qScore").textContent = (MP.role === "host") ? t("mp.host","Host") : t("mp.inRoom","En sala");

  if ($("bar")){
    const pct = ended ? 100 : Math.round(((st.qNo || 1) / Math.max(1, st.total || 10)) * 100);
    $("bar").style.width = pct + "%";
  }

  if (ended){
    $("qText").textContent = (I18N.ui["mp.endedHint"] || "Gracias. Ya puedes cerrar esta pestaña.");
    $("qHint").textContent = "";
  } else {
    $("qText").textContent = q ? (q.q || "—") : "—";
    $("qHint").textContent = q ? (q.hint || "") : "";
  }

  const wrap = $("answers");
  wrap.innerHTML = "";
  const letters = ["A","B","C","D"];
  const answers = (!ended && q && Array.isArray(q.answers)) ? q.answers : [];

  answers.forEach((a, i)=>{
    const btn = document.createElement("button");
    btn.className = "ans locked";
    btn.type = "button";
    btn.disabled = true;
    btn.innerHTML = `<span class="tag">${letters[i] || ""}</span><span class="text">${escapeHtml(a.txt || "")}</span>`;
    if (typeof correctIndex === "number" && i === correctIndex) btn.classList.add("green");
    if (MP.selectedIndex != null && i === MP.selectedIndex){
      btn.classList.add("selected");
      if (typeof correctIndex === "number" && MP.selectedIndex !== correctIndex) btn.classList.add("red");
    }
    wrap.appendChild(btn);
  });

  show("feedback");
  const _hasChoice = (MP.selectedIndex != null);
  const _isCorrect = (_hasChoice && typeof correctIndex === "number" && MP.selectedIndex === correctIndex);
  const _hasCorrect = (typeof correctIndex === "number" && correctIndex >= 0);
  const _letters2 = ["A","B","C","D"];
  const _corrLetter = _hasCorrect ? (_letters2[correctIndex] || String(correctIndex+1)) : "—";

  $("fbTitle").textContent = ended
    ? (I18N.ui["mp.endedTitle"] || "Fin")
    : (_isCorrect
        ? t("mp.correctTitle","✅ Correcto")
        : (_hasChoice ? t("mp.wrongTitle","❌ Incorrecto") : t("mp.noAnswerTitle","⏳ Sin respuesta")));


  if (ended){
    $("fbBody").textContent = (I18N.ui["mp.endedBody"] || "La partida ha terminado.");
  } else {
    let why = "";
    try{
      // si hay why en la respuesta correcta (según idioma), lo mostramos
      if (q && q.answers && typeof correctIndex === "number"){
        why = q.answers[correctIndex]?.why || "";
      }
      // fallback a base
      if (!why && qRaw && qRaw.answers){
        const baseCorrect = qRaw.answers.findIndex(a=>a.grade==="green");
        if (baseCorrect >= 0){
          const shownCorrect = Array.isArray(answerOrder) ? answerOrder.indexOf(baseCorrect) : baseCorrect;
          why = (qRaw.answers[baseCorrect]?.why || "");
          // si se reordenó y el pack no trae why, seguimos mostrando base
        }
      }
    }catch(_e){}

    const baseMsg = why ? ((_isCorrect ? "✅ " : t("mp.correctWas","✅ Correcta: ")) + why) : t("mp.revealBody","Revisa el control preventivo correcto y cómo lo comunicas.");
    if (_isCorrect){
      $("fbBody").textContent = baseMsg;
    } else if (!_hasChoice){
      $("fbBody").textContent = fmt(t("mp.noAnswerBody","⏳ No respondiste. La correcta era {L}."), {L:_corrLetter}) + (why ? (" " + baseMsg) : "");
    } else {
      $("fbBody").textContent = fmt(t("mp.wrongBody","❌ No era esa. La correcta era {L}."), {L:_corrLetter}) + (why ? (" " + baseMsg) : "");
    }
  }

  hide("followUp");

  if (MP.role === "host"){
    hide("btnReveal");
    show("btnNext");
    show("liveCounts");
  } else {
    hide("btnReveal");
    hide("btnNext");
    hide("liveCounts");
  }
}

function handleStateChange(st){
  if (!st){
    // sala borrada o estado vacío
    if (MP.role === "join"){
      hide("quiz"); hide("waiting"); show("start");
      mpSetPill("Sala no disponible");
    }
    return;
  }

  const phase = st.phase || "lobby";

  if (phase === "lobby"){
    mpRenderLobby();
    return;
  }

  if (phase === "question"){
    mpRenderQuestion(st);
    // Contadores live (host)
    if (MP.role === "host" && st.roundId){
      mpAttachCounts(st.roundId, st.answerOrder?.length || 4);
    }
    return;
  }

  if (phase === "results"){
    mpRenderResults(st);
    // Contadores live (host)
    if (MP.role === "host" && st.roundId){
      mpAttachCounts(st.roundId, st.answerOrder?.length || 4);
    }
    return;
  }

  // fallback
  mpRenderLobby();
}

// ---- Contadores (host) ----
async function mpAttachCounts(roundId, answerLen){
  if (MP.role !== "host") return;

  if (MP.unsubAnswers){ try{ MP.unsubAnswers(); }catch(_e){} MP.unsubAnswers=null; }

  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, onValue } = fb;

  const countsEl = $("liveCounts");
  if (!countsEl) return;

  MP.unsubAnswers = onValue(ref(db, `rooms/${MP.room}/answers/${roundId}`), (snap)=>{
    const obj = snap.val() || {};
    const counts = new Array(answerLen).fill(0);
    let total = 0;
    Object.keys(obj).forEach(k=>{
      const c = obj[k]?.choice;
      if (typeof c === "number" && c >= 0 && c < counts.length){
        counts[c]++; total++;
      }
    });
    countsEl.innerHTML = "";
    const letters = ["A","B","C","D"];
    counts.forEach((n,i)=>{
      const sp = document.createElement("span");
      sp.className = "countPill";
      sp.textContent = `${letters[i] || i+1}: ${n}`;
      countsEl.appendChild(sp);
    });
    const sp2 = document.createElement("span");
    sp2.className = "countPill";
    sp2.textContent = `Respondidas: ${total}`;
    countsEl.appendChild(sp2);
  }, (err)=>console.error(err));
}

// ---- Host publicar estado ----
async function mpHostPublishQuestion(){
  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, set, serverTimestamp } = fb;

  const qId = MP.qIds[MP.qIndex];
  const qRaw = QUESTIONS_BASE.find(x=>x.id===qId);
  const answerOrder = mpMakeAnswerOrder(qRaw);
  const roundId = `${Date.now()}_${qId}`;

  MP.answeredThisRound = false;
  MP.selectedIndex = null;

  await set(ref(db, `rooms/${MP.room}/state`), {
    phase: "question",
    gameId: MP.gameId,
    roundId,
    qNo: MP.qIndex + 1,
    total: MP.qIds.length,
    qId,
    answerOrder,
    ts: serverTimestamp()
  });

  mpSetPill("Sala: " + MP.room);
}

async function mpHostReveal(){
  const st = MP.current;
  if (!st || st.phase !== "question") return;

  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, set, serverTimestamp } = fb;

  const qRaw = QUESTIONS_BASE.find(x=>x.id===st.qId);
  const baseCorrect = qRaw ? (qRaw.answers || []).findIndex(a=>a.grade==="green") : -1;
  const order = Array.isArray(st.answerOrder) ? st.answerOrder : null;
  const correctIndex = (baseCorrect >= 0 && order) ? order.indexOf(baseCorrect) : baseCorrect;

  await set(ref(db, `rooms/${MP.room}/state`), {
    ...st,
    phase: "results",
    correctIndex: (typeof correctIndex === "number" && correctIndex >= 0) ? correctIndex : null,
    ts: serverTimestamp()
  });
}

async function mpHostNext(){
  const st = MP.current;
  if (!st || st.phase !== "results") return;

  // fin
  if ((MP.qIndex + 1) >= MP.qIds.length){
    const fb = await window.__getFirebase(FIREBASE_CONFIG);
    const { db, ref, set, serverTimestamp } = fb;
    await set(ref(db, `rooms/${MP.room}/state`), {
      phase: "results",
      ended: true,
      ts: serverTimestamp()
    });
    return;
  }

  MP.qIndex++;
  await mpHostPublishQuestion();
}

async function mpHostStartGame(){
  // Sólo si estamos en lobby
  const phase = MP.current?.phase || "lobby";
  if (phase !== "lobby") return;

  MP.gameId = "g_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,6);
  MP.qIds = mpPickQuestions(10);
  MP.qIndex = 0;

  // limpiar respuestas antiguas por si se reutilizó el código (best-effort)
  try{
    const fb = await window.__getFirebase(FIREBASE_CONFIG);
    const { db, ref, remove } = fb;
    await remove(ref(db, `rooms/${MP.room}/answers`));
  }catch(_e){}

  await mpHostPublishQuestion();
}

async function mpJoinStart(){
  if (!mpIsConfigured()){
    alert("Falta configurar Firebase. Edita FIREBASE_CONFIG dentro del HTML.");
    return;
  }
  const code = ($("joinCode")?.value || "").trim().replace(/\D/g,"").slice(0,6);
  if (code.length < 6){
    alert("Mete un código de 6 dígitos.");
    return;
  }

  const nameRaw = ($("joinName")?.value || "").trim();
  const name = (nameRaw || t("mp.guest","Invitado")).slice(0,24);
  const lang = currentLang();

  const fb = await window.__getFirebase(FIREBASE_CONFIG);
  const { db, ref, set, serverTimestamp, onDisconnect } = fb;

  MP.role = "join";
  MP.room = code;
  MP.pid = "p_" + Math.random().toString(36).slice(2,10);
  MP.pname = name;
  MP.plang = lang;

  // registra jugador
  await set(ref(db, `rooms/${code}/players/${MP.pid}`), {
    name: MP.pname,
    lang: MP.plang,
    joinedAt: serverTimestamp()
  });

  try{
    onDisconnect(ref(db, `rooms/${code}/players/${MP.pid}`)).remove();
  }catch(_e){}

  mpSetPill("Unido: " + code);

  // Suscripciones
  await mpSubscribeState();
  await mpSubscribePlayers();

  // entra a lobby (espera)
  mpRenderLobby();
}

// ---- Joiner: enviar respuesta ----
function mpJoinSelect(choiceIndex){
  const st = MP.current;
  if (!st || st.phase !== "question") return;
  if (MP.answeredThisRound) return;

  MP.answeredThisRound = true;
  MP.selectedIndex = choiceIndex;

  // marca selección visual
  const buttons = Array.from(document.querySelectorAll(".ans"));
  buttons.forEach((b, i)=>{
    b.disabled = true;
    b.classList.add("locked");
    if (i === choiceIndex) b.classList.add("selected");
  });

  show("feedback");
  $("fbTitle").textContent = (I18N.ui["mp.sentTitle"] || "📨 Enviado");
  $("fbBody").textContent = (I18N.ui["mp.sentBody"] || "Respuesta enviada al host. Espera a que muestre la solución.");
  hide("followUp");

  // escribe en RTDB
  (async ()=>{
    try{
      const fb = await window.__getFirebase(FIREBASE_CONFIG);
      const { db, ref, set, serverTimestamp } = fb;
      await set(ref(db, `rooms/${MP.room}/answers/${st.roundId}/${MP.pid}`), {
        choice: choiceIndex,
        ts: serverTimestamp()
      });
    }catch(e){
      console.error(e);
      $("fbTitle").textContent = "⚠ No enviado";
      $("fbBody").textContent = "No se pudo enviar. Revisa conexión / código de sala.";
      MP.answeredThisRound = false; // deja reintentar
    }
  })();
}

// ---- Handlers UI: Start / Next / Exit (sin overrides) ----
async function onStartClick(){
  const mode = mpReadModeFromUI();

  if (mode === "local"){
    startGame();
    return;
  }

  if (mode === "host"){
    if (!MP.room){
      try{
        await mpCreateRoom();
      }catch(e){
        console.error(e);
        alert("No puedo crear la sala en Firebase.\n\nDetalle: " + (e?.message || e));
      }
      return;
    }
    // Si ya hay sala, y seguimos en lobby → lanzar partida
    try{
      await mpHostStartGame();
    }catch(e){
      console.error(e);
      alert("No puedo iniciar la partida.\n\nDetalle: " + (e?.message || e));
    }
    return;
  }

  // join: se usa botón específico "Unirme"
}

async function onNextClick(){
  // si host en MP, 'Siguiente' avanza
  if (MP.role === "host"){
    try{
      await mpHostNext();
    }catch(e){
      console.error(e);
    }
    return;
  }

  // local
  next();
}

async function onExitClick(){
  // Host: al salir, cerramos sala (para no dejar salas "fantasma")
  if (MP.role === "host" && MP.room){
    try{ await mpCloseRoom(); }catch(_e){}
    return;
  }

  // Joiner: eliminar presencia al salir (best-effort)
  if (MP.role === "join" && MP.room && MP.pid){
    try{
      const fb = await window.__getFirebase(FIREBASE_CONFIG);
      const { db, ref, remove } = fb;
      await remove(ref(db, `rooms/${MP.room}/players/${MP.pid}`));
    }catch(_e){}
  }

  mpCleanup();
  mpSetPill("Listo");
  resetAll();
  showSessionUI();
}

// ---- Init MP (único) ----
function initMultiplayerRefactor(){
  // selector
  $("sessionMode")?.addEventListener("change", showSessionUI);

  // botones host/join
  $("btnJoinRoom")?.addEventListener("click", ()=>mpJoinStart().catch(e=>alert(e?.message || e)));
  $("btnCloseRoom")?.addEventListener("click", ()=>mpCloseRoom().catch(e=>alert(e?.message || e)));
  $("btnReveal")?.addEventListener("click", ()=>mpHostReveal().catch(e=>console.error(e)));

  // join param (NO auto-join)
  const sp = new URLSearchParams(location.search);
  const join = sp.get("join");
  if (join){
    $("sessionMode") && ($("sessionMode").value = "join");
    $("joinCode") && ($("joinCode").value = String(join).replace(/\D/g,"").slice(0,6));
  }

  showSessionUI();
}

// arranca tras load (cuando ya están creados los listeners base)
try{
  window.addEventListener("load", ()=>initMultiplayerRefactor());
}catch(_e){}

</script>

  <!-- LANGUAGE MODAL (shown on QR join if language not chosen yet) -->
  <div id="langModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="langTitle">
    <div class="langCard">
      <div class="langTitle" id="langTitle" data-i18n="lang.title">Elige tu idioma</div>
      <div class="langBody" data-i18n="lang.body">Selecciona tu idioma para entrar a la sala.</div>
      <div class="langGrid" id="langGrid"></div>
    </div>
  </div>

</body>
</html>
